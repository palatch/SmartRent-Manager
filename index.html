<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SMARTRENT — Mobile</title>
  <style>
    :root { --bg:#0a0f1a; --bg-2:#090e1a; --card:#1a1f2e; --text:#eef2ff; --muted:#94a3b8;
      --pri-1:#6366f1; --pri-2:#3b82f6; --pri-3:#0ea5e9; --pri-4:#0284c7;
      --radius:18px; --shadow:0 12px 36px rgba(0,0,0,.45);
      --red:#ef4444; --yellow:#facc15; --green:#22c55e; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Sarabun',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(80% 120% at 20% 0%, #0e1530 0, var(--bg) 60%, var(--bg-2) 100%);color:var(--text);padding-bottom:96px}
    a{text-decoration:none;color:inherit;cursor:pointer}
    header{padding:20px 18px 8px;display:flex;align-items:center;justify-content:space-between}
    .eyebrow{color:#6f7da1;letter-spacing:.12em;font-weight:700;font-size:.78rem}
    .title{font-size:2rem;font-weight:800;margin-top:6px}
    .add-circle{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--pri-3),#3557ef);box-shadow:0 10px 26px rgba(67,97,238,.35);color:#fff;font-size:26px}
    main{max-width:920px;margin:0 auto;padding:8px 16px}
    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px;margin:14px;border:1px solid rgba(255,255,255,.06)}
    .view{display:none}
    .view.active{display:block}
    .dock{position:fixed;left:0;right:0;bottom:18px;display:flex;justify-content:center;gap:12px}
    .dock a{min-width:140px;text-align:center;padding:14px 18px;border-radius:16px;font-weight:700;color:#fff;box-shadow:0 12px 34px rgba(0,0,0,.35)}
    .btn-sum{background:linear-gradient(135deg,#7a5cff,#3bc6f6)}
    .btn-set{background:linear-gradient(135deg,#46a0ff,#2b6fff)}

    /* Room list */
    .room-list{list-style:none;padding:0;margin:0}
    .room-card{border-radius:20px;padding:18px 16px;margin:14px 0;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;cursor:pointer;color:#fff}
    .room-num{font-size:1.35rem;font-weight:900}
    .room-sub{display:flex;gap:12px;color:#e5e7eb;opacity:.95}
    .room-amount{font-weight:800;font-size:1.2rem}
    .grad-red{background:linear-gradient(180deg,#ef4444,#b91c1c)}
    .grad-yellow{background:linear-gradient(180deg,#facc15,#ca8a04);color:#111}
    .grad-green{background:linear-gradient(180deg,#22c55e,#15803d)}
    .grad-muted{background:linear-gradient(180deg,#6b7280,#111827)}

    /* Forms */
    .form label{display:block;margin:8px 2px;color:var(--muted)}
    .form input,.form select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0e1628;color:#fff}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.row2{grid-template-columns:1fr}}

    /* Buttons */
    .btn{padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(135deg,var(--pri-1),var(--pri-2));color:#fff;border:none}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:#fff}
    .btn.danger{background:linear-gradient(135deg,#ff6b6b,#ff4757);color:#fff;border:none}

    /* Settings circle buttons */
    .circle-btn {width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.3);border:none;cursor:pointer}
    .btn-export {background:linear-gradient(135deg,#3bc6f6,#3557ef)}
    .btn-import {background:linear-gradient(135deg,#46a0ff,#2b6fff)}
    .circle-group{display:flex;gap:20px;justify-content:center;margin-top:14px}

    /* Transactions */
    .tx-list{list-style:none;padding:0;margin:0}
    .tx-list li{display:grid;grid-template-columns:92px 1fr auto;gap:8px;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .muted{color:var(--muted)}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);padding:16px;z-index:10}
    .sheet{width:min(680px,92vw);background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:18px;border:1px solid rgba(255,255,255,.06)}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="eyebrow" id="eyebrow">DASHBOARD</div>
      <div class="title" id="pageTitle">All Rooms</div>
    </div>
    <a class="add-circle" href="#" id="quickAdd">＋</a>
  </header>

  <main>
    <!-- ROOMS -->
    <section class="view active" id="viewRooms">
      <ul class="room-list" id="roomList"></ul>
    </section>

    <!-- SUMMARY -->
    <section class="view" id="viewSummary">
      <div class="card">
        <h2>สรุปรายเดือน</h2>
        <div class="row2" style="margin-top:6px"><div><label>เดือน</label><input type="month" id="sumMonth" /></div></div>
        <div class="row2" style="margin-top:10px">
          <div class="card" style="margin:0"><div class="muted">รายรับรวม</div><div id="kpiIn" style="font-size:1.3rem;font-weight:800">฿0</div></div>
          <div class="card" style="margin:0"><div class="muted">รายจ่ายรวม</div><div id="kpiOut" style="font-size:1.3rem;font-weight:800">฿0</div></div>
        </div>
        <div class="card" style="margin-top:10px"><div class="muted">กำไรสุทธิ</div><div id="kpiNet" style="font-size:1.3rem;font-weight:800">฿0</div></div>
      </div>
      <div class="card"><h2>รายการธุรกรรม</h2><ul class="tx-list" id="sumList"></ul></div>
    </section>

    <!-- SETTINGS -->
    <section class="view" id="viewSettings">
      <div class="card">
        <h2>Settings</h2>
        <p class="muted">ข้อมูลเก็บในอุปกรณ์ (localStorage, key: <code>smartrent_rooms_v1</code>) การอัปเดตไฟล์บน GitHub จะไม่ลบข้อมูล</p>
        <div class="circle-group">
          <button class="circle-btn btn-export" id="btnExport">Export</button>
          <button class="circle-btn btn-import" id="btnImport">Import</button>
        </div>
        <input type="file" id="fileImport" accept="application/json,.json" hidden />
      </div>
      <div class="card">
        <h2>Self‑Check</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px"><button class="btn" id="btnSelfCheck">Run</button></div>
        <ul class="tx-list" id="testResults" style="margin-top:8px"></ul>
      </div>
    </section>
  </main>

  <div class="dock">
    <a class="btn-sum" id="goSummary">Summary</a>
    <a class="btn-set" id="goSettings">Settings</a>
  </div>

  <!-- ADD/EDIT ROOM MODAL -->
  <div class="modal" id="modalRoom">
    <div class="sheet">
      <h2 id="modalTitle">เพิ่มห้องใหม่</h2>
      <form class="form" id="roomForm">
        <label>เลขห้อง</label>
        <input id="roomNumber" required maxlength="16">
        <div class="row2">
          <div>
            <label>วันเริ่ม</label>
            <input id="startDate" type="date" required>
          </div>
          <div>
            <label>วันสิ้นสุด</label>
            <input id="endDate" type="date" required>
          </div>
        </div>
        <div class="row2">
          <div>
            <label>วันครบกำหนด (1–31)</label>
            <input id="dueDay" type="number" min="1" max="31" required>
          </div>
          <div>
            <label>ค่าเช่า/เดือน (฿)</label>
            <input id="rentAmount" type="number" min="0" step="0.01" placeholder="เช่น 12000">
          </div>
        </div>
        <input type="hidden" id="editId">
        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
          <button class="btn primary" type="submit">บันทึก</button>
          <button class="btn ghost" type="button" id="btnCancel">ยกเลิก</button>
          <button class="btn danger" type="button" id="btnDelete" style="margin-left:auto;display:none">ลบห้อง</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ROOM DETAIL + TRANSACTIONS MODAL -->
  <div class="modal" id="modalDetail">
    <div class="sheet">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px"><h2 id="detailTitle">รายละเอียดห้อง</h2><div style="display:flex;gap:8px"><button class="btn ghost" id="btnEditRoom">แก้ไข</button><button class="btn danger" id="btnDeleteRoom2">ลบห้อง</button></div></div>
      <div class="card" style="margin:10px 0"><div class="muted" id="detailInfo">—</div></div>
      <div class="card" style="margin:10px 0">
        <h3>เพิ่มธุรกรรม</h3>
        <form class="form" id="txForm">
          <div class="row2">
            <div>
              <label>ประเภท</label>
              <select id="txType"><option value="income">รายรับ</option><option value="expense">รายจ่าย</option></select>
            </div>
            <div>
              <label>วันที่</label>
              <input type="date" id="txDate" required>
            </div>
          </div>
          <label>หมวด</label>
          <input id="txCat" placeholder="เช่น ค่าเช่า / ล้างแอร์" required>
          <label>จำนวนเงิน (฿)</label>
          <input type="number" id="txAmount" min="0" step="0.01" required>
          <label>รายละเอียด</label>
          <input id="txDetail" maxlength="100">
          <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap">
            <button class="btn primary" type="submit">บันทึก</button>
            <button class="btn ghost" type="button" id="txClose">ปิด</button>
          </div>
        </form>
      </div>
      <div class="card" style="margin:10px 0">
        <h3>รายการธุรกรรม</h3>
        <ul class="tx-list" id="txList"></ul>
        <div class="muted" id="txTotal" style="text-align:right;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Data layer =====
    const LOCAL_KEY='smartrent_rooms_v1';
    let rooms=[];
    const pad = n => n.toString().padStart(2,'0');
    const money = n => '฿'+Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2});
    const monthKey = d => d.getFullYear()+"-"+pad(d.getMonth()+1);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const genId = () => Date.now().toString(36)+Math.random().toString(36).slice(2,8);
    const fmtTH = s => { if(!s) return ''; const d=new Date(s); if(isNaN(d)) return s; return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()+543}`; };

    function saveData(){ localStorage.setItem(LOCAL_KEY, JSON.stringify(rooms)); }
    function loadData(){ try{ const d=localStorage.getItem(LOCAL_KEY); rooms=d?JSON.parse(d):[]; }catch{ rooms=[]; } }

    // ===== Business logic =====
    function statusOf(r){
      if(!(r.transactions||[]).length) return {cls:'grad-muted',text:'Vacant'};
      const now=new Date(); const end=new Date(r.endDate);
      const diff=(end.getFullYear()-now.getFullYear())*12 + (end.getMonth()-now.getMonth());
      if (diff<3 || (diff===3 && end.getDate()<=now.getDate())) return {cls:'grad-red',text:'Expiring soon'};
      const ym=monthKey(now);
      const paid=(r.transactions||[]).some(t=> t.type==='income' && t.category==='ค่าเช่า' && t.date?.startsWith(ym));
      const due=new Date(now.getFullYear(), now.getMonth(), r.dueDay);
      if (now>due && !paid) return {cls:'grad-yellow',text:'Overdue'};
      return {cls:'grad-green',text:'Occupied'};
    }
    function monthNet(r, ym){ let s=0; for(const t of (r.transactions||[])){ if(t.date?.startsWith(ym)){ s += (t.type==='income'?1:-1)*Number(t.amount||0); } } return s; }

    // ===== Routing =====
    const views={rooms:document.getElementById('viewRooms'), summary:document.getElementById('viewSummary'), settings:document.getElementById('viewSettings')};
    function setView(name){ Object.values(views).forEach(v=>v.classList.remove('active')); views[name].classList.add('active'); document.getElementById('pageTitle').textContent = name==='rooms'? 'All Rooms': (name==='summary'? 'Summary':'Settings'); }
    function route(){ const h=location.hash.replace('#',''); if(h==='summary') setView('summary'); else if(h==='settings') setView('settings'); else setView('rooms'); if(h==='summary') renderSummary(); }
    window.addEventListener('hashchange', route);

    // ===== Rooms UI =====
    function renderRooms(){ const ul=document.getElementById('roomList'); ul.innerHTML=''; const ym=monthKey(new Date());
      const sorted = rooms.slice().sort((a,b)=>{ const rk={'grad-red':0,'grad-yellow':1,'grad-green':2,'grad-muted':3}; const ra=rk[statusOf(a).cls], rb=rk[statusOf(b).cls]; return ra-rb || String(a.roomNumber).localeCompare(String(b.roomNumber),'th'); });
      for(const r of sorted){ const st=statusOf(r); const net=monthNet(r,ym); const li=document.createElement('li'); li.className='room-card '+st.cls; li.innerHTML=`<div><div class="room-num">${r.roomNumber}</div><div class="room-sub">${st.text} · Rent: ${r.rent? money(r.rent):'—'}</div></div><div class="room-amount">${net>=0?'+':'-'}${money(Math.abs(net))}</div>`; li.onclick=()=>openDetail(r.id); ul.appendChild(li);} if(!sorted.length){ ul.innerHTML='<li class="card" style="list-style:none">ยังไม่มีห้อง — แตะ ＋ เพื่อเพิ่ม</li>'; } }

    // ===== Add/Edit Room modal =====
    const modalRoom=document.getElementById('modalRoom');
    const roomForm=document.getElementById('roomForm');
    const editId=document.getElementById('editId');
    document.getElementById('quickAdd').addEventListener('click', e=>{ e.preventDefault(); openRoomModal(); });
    document.getElementById('btnCancel').addEventListener('click', closeRoomModal);
    document.getElementById('btnDelete').addEventListener('click', deleteRoomFromModal);
    modalRoom.addEventListener('click',e=>{ if(e.target===modalRoom) closeRoomModal(); });

    function openRoomModal(id){ const editing=Boolean(id); document.getElementById('modalTitle').textContent = editing? 'แก้ไขห้อง' : 'เพิ่มห้องใหม่'; document.getElementById('btnDelete').style.display = editing? 'inline-flex':'none'; roomForm.reset(); editId.value=id||''; if(editing){ const r=rooms.find(x=>x.id===id); if(!r) return; roomNumber.value=r.roomNumber; startDate.value=r.startDate; endDate.value=r.endDate; dueDay.value=r.dueDay; rentAmount.value=r.rent||''; } modalRoom.style.display='grid'; }
    function closeRoomModal(){ modalRoom.style.display='none'; }
    function deleteRoomFromModal(){ const id=editId.value; if(!id) return; if(!confirm('ลบห้องและข้อมูลทั้งหมด?')) return; rooms=rooms.filter(x=>x.id!==id); saveData(); closeRoomModal(); renderRooms(); }

    roomForm.addEventListener('submit', e=>{ e.preventDefault(); const payload={ roomNumber:roomNumber.value.trim(), startDate:startDate.value, endDate:endDate.value, dueDay:parseInt(dueDay.value,10), rent: parseFloat(rentAmount.value||'0')||undefined, transactions:[] };
      if(!payload.roomNumber) return alert('กรุณากรอกเลขห้อง');
      const id=editId.value; if(id){ const r=rooms.find(x=>x.id===id); Object.assign(r, payload, {transactions:r.transactions||[]}); } else { if(rooms.some(x=>String(x.roomNumber)===String(payload.roomNumber))) return alert('เลขห้องซ้ำ'); rooms.push({ id:genId(), ...payload }); }
      saveData(); closeRoomModal(); renderRooms(); });

    // ===== Room Detail + Transactions modal =====
    const modalDetail=document.getElementById('modalDetail');
    const txForm=document.getElementById('txForm');
    const txList=document.getElementById('txList');
    const txTotal=document.getElementById('txTotal');
    let currentRoomId=null;

    function openDetail(id){ const r=rooms.find(x=>x.id===id); if(!r) return; currentRoomId=id; document.getElementById('detailTitle').textContent='ห้อง '+r.roomNumber; document.getElementById('detailInfo').textContent=`สัญญา: ${fmtTH(r.startDate)}–${fmtTH(r.endDate)} · ครบกำหนด: ${r.dueDay}${r.rent? ' · ค่าเช่า: '+money(r.rent):''}`; document.getElementById('btnEditRoom').onclick=()=>openRoomModal(r.id); document.getElementById('btnDeleteRoom2').onclick=()=>{ if(!confirm('ลบห้องนี้ทั้งหมด?')) return; rooms=rooms.filter(x=>x.id!==r.id); saveData(); closeDetail(); renderRooms(); }; txDate.value=todayISO(); txCat.value='ค่าเช่า'; txAmount.value=''; txDetail.value=''; renderTxList(r); modalDetail.style.display='grid'; }
    function closeDetail(){ modalDetail.style.display='none'; currentRoomId=null; }
    document.getElementById('txClose').addEventListener('click', closeDetail);
    modalDetail.addEventListener('click', e=>{ if(e.target===modalDetail) closeDetail(); });

    function renderTxList(r){ txList.innerHTML=''; let sum=0; const arr=(r.transactions||[]).slice().sort((a,b)=>a.date.localeCompare(b.date)); for(const t of arr){ sum += (t.type==='income'?1:-1)*Number(t.amount||0); const li=document.createElement('li'); li.innerHTML = `<span class="muted">${fmtTH(t.date)}</span><span>${t.category}${t.detail? ': '+t.detail:''}</span><span class="${t.type==='income'?'':'neg'}">${t.type==='income'?'+':'-'}${money(t.amount)}</span>`; const del=document.createElement('button'); del.className='btn ghost'; del.textContent='ลบ'; del.onclick=()=>{ if(!confirm('ลบรายการนี้?')) return; const rr=rooms.find(x=>x.id===r.id); rr.transactions=(rr.transactions||[]).filter(x=>x.id!==t.id); saveData(); renderTxList(rr); renderRooms(); }; li.appendChild(del); txList.appendChild(li); } txTotal.textContent='ยอดสุทธิทั้งหมด: '+ (sum>=0?'+':'-') + money(Math.abs(sum)); }

    txForm.addEventListener('submit', e=>{ e.preventDefault(); if(!currentRoomId) return; const r=rooms.find(x=>x.id===currentRoomId); if(!r) return; const type=document.getElementById('txType').value; const category=document.getElementById('txCat').value.trim(); const date=document.getElementById('txDate').value; const amount=parseFloat(document.getElementById('txAmount').value); const detail=(document.getElementById('txDetail').value||'').trim(); if(!category) return alert('กรุณาระบุหมวด'); if(!(amount>0)) return alert('จำนวนเงินไม่ถูกต้อง'); if(!date) return alert('กรุณาเลือกวันที่'); r.transactions=r.transactions||[]; r.transactions.push({ id:genId(), type, category, date, amount, detail }); saveData(); renderTxList(r); renderRooms(); document.getElementById('txAmount').value=''; document.getElementById('txDetail').value=''; });

    // ===== Summary =====
    function renderSummary(){ const ym = sumMonth.value || monthKey(new Date()); sumMonth.value=ym; const items=[]; let inSum=0, outSum=0; for(const r of rooms){ for(const t of (r.transactions||[])){ if(t.date?.startsWith(ym)){ items.push({room:r.roomNumber, ...t}); if(t.type==='income') inSum+=Number(t.amount||0); else outSum+=Number(t.amount||0); } } } items.sort((a,b)=>a.date.localeCompare(b.date)); document.getElementById('kpiIn').textContent = money(inSum); document.getElementById('kpiOut').textContent = money(outSum); document.getElementById('kpiNet').textContent = money(inSum-outSum); const ul=document.getElementById('sumList'); ul.innerHTML=''; if(!items.length){ ul.innerHTML='<li class="muted" style="padding:10px">ไม่มีรายการในเดือนนี้</li>'; return; } for(const t of items){ const li=document.createElement('li'); li.innerHTML=`<span class="muted">${fmtTH(t.date)}</span><span>ห้อง ${t.room} · ${t.category}${t.detail?': '+t.detail:''}</span><span class="${t.type==='income'?'':'neg'}">${t.type==='income'?'+':'-'}${money(t.amount)}</span>`; ul.appendChild(li); } }
    document.getElementById('sumMonth').addEventListener('change', renderSummary);

    // ===== Settings (Export / Import JSON) =====
    document.getElementById('btnExport').addEventListener('click', ()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(rooms,null,2)],{type:'application/json'})); a.download='rentData.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); });
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileImport').click());
    document.getElementById('fileImport').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; try{ const txt=await f.text(); const data=JSON.parse(txt); if(!Array.isArray(data)) throw new Error('รูปแบบไม่ถูกต้อง (ต้องเป็น array)'); rooms=data; saveData(); alert('นำเข้าข้อมูลสำเร็จ'); renderRooms(); if(location.hash==='#summary') renderSummary(); }catch(err){ alert('นำเข้าข้อมูลผิดพลาด: '+(err.message||err)); } e.target.value=''; });

    // ===== Self-check =====
    document.getElementById('btnSelfCheck').addEventListener('click', ()=>{ const ul=document.getElementById('testResults'); ul.innerHTML=''; const log=(ok,msg)=>{ const li=document.createElement('li'); li.innerHTML=`<span class="muted">${ok?'PASS':'FAIL'}</span><span>${msg}</span>`; ul.appendChild(li); };
      try{ const before=rooms.length; const id=genId(); rooms.push({id,roomNumber:'ZZ_TEST',startDate:'2025-01-01',endDate:'2025-12-31',dueDay:15,transactions:[]}); saveData(); log(true,'เพิ่มห้องทดสอบ'); const r=rooms.find(x=>x.id===id); r.transactions.push({id:genId(),type:'income',category:'ค่าเช่า',date:'2025-02-01',amount:999}); saveData(); log(true,'เพิ่มธุรกรรม'); r.transactions.splice(0,1); saveData(); log(r.transactions.length===0,'ลบธุรกรรม'); rooms=rooms.filter(x=>x.id!==id); saveData(); log(rooms.length===before,'ลบห้องและคืนสถานะเดิม'); }catch(e){ log(false,'ผิดพลาด: '+(e?.message||e)); }
    });

    // ===== Boot =====
    function boot(){ loadData(); renderRooms(); route(); if(location.hash==='#summary') renderSummary(); }
    // Navigation buttons
    document.getElementById('goSummary').addEventListener('click',()=>{location.hash='summary'; route();});
    document.getElementById('goSettings').addEventListener('click',()=>{location.hash='settings'; route();});
    boot();
  </script>
</body>
</html>
