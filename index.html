<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (Mobile App Style)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Tailwind ‡πÅ‡∏•‡∏∞ Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap');
        
        /* Hardcoded Dark Mode Theme - Minimalist Slate */
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc; /* slate-50 */
            height: 100vh;
            overflow: hidden;
        }
        
        .page-content { display: none; }
        .active-page { display: block; }
        .shadow-app { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px -1px rgba(0, 0, 0, 0.5); }
        .shadow-nav { box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.4); }

        /* App Bar and Card Backgrounds */
        header, footer, .card-modal, .card-surface {
            background-color: #1e293b; /* slate-800 */
            color: #f8fafc;
        }

        /* Form Inputs in Dark Theme */
        input[type="text"], input[type="number"], input[type="date"], input[type="url"], select, textarea {
            background-color: #334155; /* slate-700 */
            color: #f8fafc;
            border: 1px solid #475569; /* slate-600 */
            transition: all 0.15s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #6366f1; /* indigo-500 */
            outline: none;
            box-shadow: 0 0 0 1px #6366f1;
        }
        
        /* Nav Item - Minimalist Look */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0;
            color: #94a3b8; /* slate-400 */
            transition: all 0.2s;
            flex-grow: 1;
        }
        .nav-item.active {
            color: #a5b4fc; /* indigo-300 */
        }
        
        /* Main content area padding to account for fixed header and footer */
        #app-wrapper {
            padding-top: 56px; /* Header height (14*4) */
            padding-bottom: 72px; /* Footer height (16+8*2) */
            overflow-y: auto;
            height: 100%;
        }

        /* Room Status Colors (Simplified and modern) */
        .status-red { background-color: #dc2626; } /* red-600 (CRITICAL: Task Overdue OR Contract Ending) */
        .status-yellow { background-color: #facc15; } /* yellow-400 (WARNING: Payment Overdue) */
        .status-green { background-color: #10b981; } /* emerald-500 (NORMAL) */
        .status-gray { background-color: #475569; } /* slate-600 (VACANT) */

        .room-card { transition: all 0.2s; }
        .room-card:active { transform: scale(0.98); }

        /* General Buttons */
        .btn-primary { background-color: #6366f1; color: white; transition: background-color 0.15s; }
        .btn-primary:hover { background-color: #4f46e5; }
        
        .btn-secondary { background-color: #475569; color: #cbd5e1; }
        .btn-secondary:hover { background-color: #334155; }
        
        /* Task Status Dot */
        .task-dot-pending { background-color: #facc15; }
        .task-dot-complete { background-color: #10b981; }
        .task-dot-overdue { background-color: #dc2626; }
    </style>
</head>
<body class="min-h-screen">

    <!-- ****************************** Top App Bar (Fixed Header) ****************************** -->
    <header class="shadow-app fixed top-0 left-0 right-0 h-14 z-40">
        <div class="relative flex justify-end items-center h-full max-w-lg mx-auto px-4">
            
            <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (Centered Title - Absolute Positioning) -->
            <h1 id="pageTitle" 
                class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xl font-extrabold text-indigo-400">
                <!-- Content will be injected by JS navigateTo function -->
            </h1>
            
            <!-- FAB for Add Room (inside Header) -->
            <button id="fabAddRoom" onclick="openRoomModal(null)" 
                    class="w-10 h-10 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full text-xl shadow-md transition duration-300 transform hover:scale-105 z-50 flex items-center justify-center">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </header>

    <!-- ****************************** Main Content Area ****************************** -->
    <div id="app-wrapper">
        <main class="h-full">

            <!-- Content Pages Wrapper -->
            <div id="app" class="p-4 pt-4">

                <!-- ****************************** ‡∏´‡∏ô‡πâ‡∏≤ 1: ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Rooms) ****************************** -->
                <div id="pageRooms" class="page-content active-page">
                    
                    <p class="text-xs text-gray-500 mb-1 font-semibold">DASHBOARD</p>
                    <h2 class="text-3xl font-bold mb-4">All Rooms</h2>

                    <!-- Overall Summary Card (Minimalist) -->
                    <div id="summaryCard" class="card-surface p-4 rounded-xl shadow-md mb-6 grid grid-cols-2 gap-3">
                        <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                    </div>
                    
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤ (Room List) -->
                    <div id="roomList" class="space-y-3">
                        <!-- ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                    </div>
                    
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
                    <div id="noDataMessage" class="hidden text-center p-10 card-surface rounded-xl shadow-md mt-8 text-gray-400">
                        <p class="text-lg">üëã ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤</p>
                        <p class="text-sm mt-2">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á (+) ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</p>
                    </div>
                </div>

                <!-- ****************************** ‡∏´‡∏ô‡πâ‡∏≤ 2: ‡∏™‡∏£‡∏∏‡∏õ (Summary) ****************************** -->
                <div id="pageSummary" class="page-content">
                    <h2 class="text-base font-semibold text-gray-400 mb-4">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>

                    <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
                    <div class="card-surface p-4 rounded-xl shadow-md mb-6 grid grid-cols-2 gap-3 items-end">
                        <div class="col-span-2">
                            <label for="summaryStartDate" class="block text-xs font-medium text-gray-400 mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input type="date" id="summaryStartDate" class="w-full p-2 rounded-lg text-sm">
                        </div>
                        <div class="col-span-2">
                            <label for="summaryEndDate" class="block text-xs font-medium text-gray-400 mb-1">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                            <input type="date" id="summaryEndDate" class="w-full p-2 rounded-lg text-sm">
                        </div>
                        <div class="col-span-2">
                            <button onclick="renderSummaryPage()" class="w-full btn-primary font-bold py-2 rounded-lg transition duration-200 shadow-sm text-sm">
                                <i class="fas fa-filter mr-2"></i> ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                        <div class="col-span-2">
                             <button id="analyzeButton" onclick="analyzeFinancialsWithGemini()" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 rounded-lg transition duration-200 shadow-sm shadow-pink-500/30 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                                <span id="analyzeBtnText">‚ú® ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (AI)</span>
                                <i id="analyzeLoader" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Result Display Area -->
                    <div id="geminiInsight" class="card-surface p-4 rounded-xl shadow-md mb-6 border border-pink-700 hidden">
                        <h3 class="text-base font-bold text-pink-400 mb-3 flex items-center">
                            <i class="fas fa-magic mr-2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡∏à‡∏≤‡∏Å Gemini
                        </h3>
                        <div id="insightContent" class="prose max-w-none text-gray-300 text-sm">
                            <!-- LLM content goes here -->
                        </div>
                    </div>
                    <!-- End Gemini Insight Feature -->

                    <h2 class="text-base font-semibold text-gray-400 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏´‡πâ‡∏≠‡∏á</h2>
                    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏´‡πâ‡∏≠‡∏á -->
                    <div id="summaryReport" class="space-y-3">
                        <!-- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                    </div>
                </div>

                <!-- ****************************** ‡∏´‡∏ô‡πâ‡∏≤ 3: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings) ****************************** -->
                <div id="pageSettings" class="page-content">
                    <p class="text-xs text-gray-500 mb-1 font-semibold">DASHBOARD</p>
                    <h2 class="text-3xl font-bold mb-4">Settings</h2>
                    
                    <div class="space-y-4">
                        
                        <!-- 1. Data Management Card (Export/Import) -->
                        <div id="settingsCardData" class="card-surface p-5 rounded-xl shadow-lg border border-gray-700">
                            <h3 class="text-xl font-bold text-gray-200 mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Management)</h3>
                            <p class="text-sm text-gray-400 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (localStorage, Key: <span class="text-indigo-400 font-mono">${STORAGE_KEY}</span>)</p>
                            
                            <!-- Export Section -->
                            <div class="flex space-x-3 mb-4">
                                <button onclick="exportDataToCsv()" class="flex-1 btn-primary text-white font-bold py-3 rounded-lg shadow-md text-sm">
                                    Export CSV
                                </button>
                                
                                <!-- Import Section -->
                                <button onclick="document.getElementById('importFileInput').click()" class="flex-1 btn-primary text-white font-bold py-3 rounded-lg shadow-md text-sm">
                                    Import JSON
                                </button>
                            </div>
                            <!-- Hidden input for file selection -->
                            <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="handleImportClick()">

                            <p class="text-xs text-gray-500 border-t border-gray-700 pt-3">
                                <i class="fas fa-info-circle mr-1"></i> ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå JSON ‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </p>
                        </div>

                        <!-- 2. System Check / Debug Card -->
                        <div id="settingsCardSystem" class="card-surface p-5 rounded-xl shadow-lg border border-gray-700">
                            <h3 class="text-xl font-bold text-gray-200 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö (System Info)</h3>
                            
                            <div class="flex justify-between items-center mb-4 p-3 bg-gray-700 rounded-lg">
                                <p class="text-sm font-medium text-gray-300">Self-Check / Debug Mode</p>
                                <button onclick="runSelfCheck()" class="btn-secondary text-gray-200 font-bold py-2 px-4 rounded-lg shadow-md text-sm">
                                    Run
                                </button>
                            </div>
                            
                            <div id="selfCheckResult" class="text-xs text-gray-400 space-y-1">
                                <p>Project ID: <span id="appIdDisplay" class="font-mono text-indigo-400">N/A</span></p>
                                <p>Room Count: <span id="roomCountDisplay" class="font-mono text-indigo-400">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>
    <!-- End Main Content Area -->
    
    <!-- Bottom Navigation Bar (Fixed) - Mobile App Style -->
    <footer class="fixed bottom-0 left-0 right-0 shadow-nav z-50 p-2 bg-[#1e293b]">
        <div class="flex justify-around max-w-lg mx-auto">
            <button id="navRooms" onclick="navigateTo('rooms')" class="nav-item active">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs font-medium">‡∏´‡πâ‡∏≠‡∏á</span>
            </button>
            <button id="navSummary" onclick="navigateTo('summary')" class="nav-item">
                <i class="fas fa-chart-pie text-xl"></i>
                <span class="text-xs font-medium">‡∏™‡∏£‡∏∏‡∏õ</span>
            </button>
            <button id="navSettings" onclick="navigateTo('settings')" class="nav-item">
                <i class="fas fa-cog text-xl"></i>
                <span class="text-xs font-medium">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </button>
        </div>
    </footer>


    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤ (Room Modal) -->
    <div id="roomModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center p-4 z-50">
        <div class="card-modal rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 id="roomModalTitle" class="text-xl font-bold text-indigo-400">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
                <button onclick="closeModal('roomModal')" class="text-gray-400 hover:text-gray-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="roomForm" class="p-4" onsubmit="handleRoomFormSubmit(event)">
                <input type="hidden" id="roomIdInput">
                <div class="mb-3">
                    <label for="roomNumberInput" class="block text-sm font-medium text-gray-400 mb-1">‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</label>
                    <input type="text" id="roomNumberInput" required class="w-full p-3 rounded-lg text-white" placeholder="‡πÄ‡∏ä‡πà‡∏ô C2-503">
                </div>
                <div class="mb-3">
                    <label for="tenantNameInput" class="block text-sm font-medium text-gray-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á)</label>
                    <input type="text" id="tenantNameInput" class="w-full p-3 rounded-lg text-white" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢">
                </div>
                <div class="mb-3 grid grid-cols-2 gap-3">
                    <div>
                        <label for="startDateInput" class="block text-sm font-medium text-gray-400 mb-1">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                        <input type="date" id="startDateInput" required class="w-full p-3 rounded-lg text-white">
                    </div>
                    <div>
                        <label for="endDateInput" class="block text-sm font-medium text-gray-400 mb-1">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                        <input type="date" id="endDateInput" required class="w-full p-3 rounded-lg text-white">
                    </div>
                </div>
                <div class="mb-3 grid grid-cols-2 gap-3">
                    <div>
                        <label for="dueDayInput" class="block text-sm font-medium text-gray-400 mb-1">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (1-31)</label>
                        <input type="number" id="dueDayInput" required min="1" max="31" class="w-full p-3 rounded-lg text-white" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15">
                    </div>
                    <div>
                        <label for="rentAmountInput" class="block text-sm font-medium text-gray-400 mb-1">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ø)</label>
                        <input type="number" id="rentAmountInput" required min="1" class="w-full p-3 rounded-lg text-white" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5000">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="contractLinkInput" class="block text-sm font-medium text-gray-400 mb-1">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (URL)</label>
                    <input type="url" id="contractLinkInput" class="w-full p-3 rounded-lg text-white" placeholder="https://drive.google.com/sharelink...">
                </div>

                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md text-sm">
                    <i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button type="button" onclick="requestDeleteRoom()" id="deleteRoomButton" class="w-full mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md text-sm hidden">
                    <i class="fas fa-trash-alt mr-2"></i> ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
                </button>
            </form>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° (Transaction Modal) -->
    <div id="transactionModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center p-4 z-50">
        <div class="card-modal rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 id="transactionModalTitle" class="text-lg font-semibold text-gray-300">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á [‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á]</h3>
                <button onclick="closeModal('transactionModal')" class="text-gray-400 hover:text-gray-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà -->
            <form id="transactionForm" class="p-4 border-b border-gray-700" onsubmit="handleTransactionFormSubmit(event)">
                <input type="hidden" id="transactionRoomIdInput">
                <h4 class="text-base font-medium text-gray-400 mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h4>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <select id="transactionTypeInput" required class="col-span-1 w-full p-2 rounded-lg text-sm">
                        <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                        <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    </select>
                    <input type="date" id="transactionDateInput" required class="col-span-1 w-full p-2 rounded-lg text-sm">
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <input type="number" id="transactionAmountInput" required min="1" class="col-span-3 lg:col-span-1 w-full p-2 rounded-lg text-sm" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
                    <input type="text" id="transactionDetailInput" required class-="col-span-3 lg:col-span-1 w-full p-2 rounded-lg text-sm" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                    <input type="url" id="proofLinkInput" class="col-span-3 lg:col-span-1 w-full p-2 rounded-lg text-sm" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                <button type="submit" class="w-full mt-3 bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition duration-200 shadow-md text-sm">
                    <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
            </form>

            <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
            <div class="p-4 max-h-80 overflow-y-auto custom-scroll">
                <h4 class="text-base font-medium text-gray-400 mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h4>
                <div id="transactionList" class="space-y-3">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (Task Modal) -->
    <div id="taskModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center p-4 z-50">
        <div class="card-modal rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 id="taskModalTitle" class="text-xl font-bold text-indigo-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö [‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á]</h3>
                <button onclick="closeModal('taskModal')" class="text-gray-400 hover:text-gray-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà -->
            <form id="taskForm" class="p-4 border-b border-gray-700" onsubmit="handleTaskFormSubmit(event)">
                <input type="hidden" id="taskRoomIdInput">
                <h4 class="text-base font-medium text-gray-400 mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°/‡∏ö‡∏≥‡∏£‡∏∏‡∏á</h4>
                <div class="mb-3">
                    <input type="text" id="taskDetailInput" required class="w-full p-3 rounded-lg text-white text-sm" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏£‡πå, ‡∏ã‡πà‡∏≠‡∏°‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥)">
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label for="taskFrequencyInput" class="block text-sm font-medium text-gray-400 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                        <select id="taskFrequencyInput" class="w-full p-3 rounded-lg text-white text-sm" onchange="toggleTaskDeadline()">
                            <option value="0">‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
                            <option value="6">‡∏ó‡∏∏‡∏Å 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏£‡πå)</option>
                            <option value="12">‡∏ó‡∏∏‡∏Å 1 ‡∏õ‡∏µ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û)</option>
                            <option value="3">‡∏ó‡∏∏‡∏Å 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        </select>
                    </div>
                    <div>
                        <label for="taskDeadlineInput" id="taskDeadlineLabel" class="block text-sm font-medium text-gray-400 mb-1">‡∏ß‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ)</label>
                        <input type="date" id="taskDeadlineInput" required class="w-full p-3 rounded-lg text-white text-sm">
                    </div>
                </div>

                <div id="lastCompletedGroup" class="mb-3 hidden">
                    <label for="taskLastCompletedInput" class="block text-sm font-medium text-gray-400 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
                    <input type="date" id="taskLastCompletedInput" class="w-full p-3 rounded-lg text-white text-sm">
                </div>

                <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md text-sm">
                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô
                </button>
            </form>

            <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
            <div class="p-4 max-h-80 overflow-y-auto custom-scroll">
                <h4 class="text-base font-medium text-gray-400 mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</h4>
                <div id="taskList" class="space-y-3">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Generic Confirmation Modal - ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô window.confirm() -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center p-4 z-50">
        <div class="card-modal rounded-xl shadow-2xl w-full max-w-xs p-5 transform transition-all duration-300">
            <div class="text-center mb-4">
                <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
            </div>
            <h3 id="confirmTitle" class="text-lg font-semibold text-gray-200 mb-2 text-center">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <p id="confirmMessage" class="text-sm text-gray-400 mb-5 text-center">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</p>
            <div class="flex justify-between space-x-3">
                <button id="confirmCancelBtn" class="flex-1 btn-secondary text-gray-200 font-bold py-2 rounded-lg transition duration-200 text-sm">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button id="confirmOkBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-200 text-sm">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box - ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô window.alert() -->
    <div id="appMessageBox" class="fixed top-4 right-4 p-3 rounded-xl shadow-xl transition-all duration-300 opacity-0 transform translate-x-10 z-50 text-sm font-medium"></div>


    <script>
        const appId = (typeof __app_id !== 'undefined' && __app_id !== null) ? __app_id : 'default-app-id';
        const apiKey = "";
        
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('appIdDisplay').textContent = appId;
        });

        const STORAGE_KEY = 'RENTAL_MANAGER_DATA_V3_DARK';
        let rentalData = [];
        let currentRoomId = null;

        // --- Helper Functions ---

        function generateId() {
            return 'id-' + Date.now() + Math.random().toString(16).substring(2, 8);
        }

        function formatCurrency(number) {
            const num = Number(number);
            if (isNaN(num)) return 'N/A';
            return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(num);
        }
        
        function getDueDateText(dueDay) {
            if (!dueDay) return 'N/A';
            return `‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dueDay}`;
        }
        
        /**
         * Determines the status and priority of a room based on contract, tasks, and payment.
         * Priority order: Red (Contract/Task Critical) -> Yellow (Payment Overdue) -> Green (Normal)
         * Priority mapping: Red=3, Yellow=2, Green=1
         */
        function getRoomStatus(room) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const endDate = new Date(room.endDate);
            endDate.setHours(0, 0, 0, 0);
            
            const startDate = new Date(room.startDate);
            startDate.setHours(0, 0, 0, 0);

            // --- 1. Check for Vacant status ---
            if (endDate < today || startDate > today || room.rentAmount === 0) {
                 return { status: 'Vacant', colorClass: 'status-gray', text: '‡∏ß‡πà‡∏≤‡∏á/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤', priority: 0 };
            }


            // --- 2. Red: Critical Issues (Priority 3) ---
            const sixtyDaysFromNow = new Date();
            sixtyDaysFromNow.setDate(today.getDate() + 60);
            
            const isContractCritical = endDate <= sixtyDaysFromNow;
            
            // Check 2: Task Overdue (Deadline Passed and status is false/pending)
            const isTaskOverdue = room.tasks && room.tasks.some(task => {
                const deadline = task.frequencyMonths > 0 && task.lastCompletedDate
                    ? getNextDeadline(task.lastCompletedDate, task.frequencyMonths)
                    : new Date(task.deadline);
                
                deadline.setHours(23, 59, 59, 999);
                return !task.isComplete && deadline < today;
            });

            if (isContractCritical || isTaskOverdue) {
                let statusText = '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô';
                if (isTaskOverdue) statusText = '‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á';
                if (isContractCritical) statusText = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î';
                if (isContractCritical && isTaskOverdue) statusText = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á';

                return { status: 'Critical', colorClass: 'status-red', text: statusText, priority: 3 };
            }


            // --- 3. Yellow: Overdue Payment (Priority 2) ---
            const currentDay = today.getDate();
            const dueDay = room.dueDay || 1;
            
            if (currentDay >= dueDay) {
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                
                const latestPayment = room.transactions
                    .filter(t => t.type === 'income' && new Date(t.date) >= startOfMonth && t.amount === room.rentAmount)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                if (!latestPayment) {
                    return { status: 'Overdue', colorClass: 'status-yellow', text: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞/‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î', priority: 2 };
                }
            }


            // --- 4. Green: Normal Occupied (Priority 1) ---
            return { status: 'Normal', colorClass: 'status-green', text: '‡∏õ‡∏Å‡∏ï‡∏¥/‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤', priority: 1 };
        }
        
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('flex');
            
            // Disable FAB when modal is open
            document.getElementById('fabAddRoom').disabled = true;
            document.getElementById('fabAddRoom').classList.add('opacity-50');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
            
            // Enable FAB when modal is closed
            document.getElementById('fabAddRoom').disabled = false;
            document.getElementById('fabAddRoom').classList.remove('opacity-50');
        }


        function showMessage(text, isError = false) {
            const box = document.getElementById('appMessageBox');
            box.textContent = text;
            
            box.classList.remove('opacity-0', 'translate-x-10', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            box.classList.add('opacity-100', 'transform', 'translate-x-0');
            
            if (isError) {
                box.classList.add('bg-red-500', 'text-white');
                box.style.backgroundColor = '#f87171'; // red-500
            } else {
                box.classList.add('bg-green-500', 'text-white');
                box.style.backgroundColor = '#34d399'; // green-500
            }

            setTimeout(() => {
                box.classList.remove('opacity-100', 'transform', 'translate-x-0');
                box.classList.add('opacity-0', 'translate-x-10');
            }, 3000);
        }

        // --- Confirmation Modal Logic (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà window.confirm) ---
        let confirmationCallback = null;

        function openConfirmationModal(title, message, callback, isDestructive = true) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmationCallback = callback;
            
            const okBtn = document.getElementById('confirmOkBtn');
            okBtn.className = isDestructive 
                ? 'flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-200 text-sm' 
                : 'flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-200 text-sm';

            openModal('confirmationModal');
        }

        function closeConfirmationModal(result) {
            closeModal('confirmationModal');
            if (confirmationCallback) {
                confirmationCallback(result);
                confirmationCallback = null;
            }
        }

        // --- Navigation Logic ---

        const PAGES = ['rooms', 'summary', 'settings'];
        const PAGE_TITLES = {
            'rooms': '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
            'summary': '‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
            'settings': '‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤'
        };

        function navigateTo(pageId) {
            // 1. Update Navigation UI (Mobile Bottom Nav)
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`nav${pageId.charAt(0).toUpperCase() + pageId.slice(1)}`)?.classList.add('active');


            // 2. Hide all pages and show the target page
            PAGES.forEach(page => {
                document.getElementById(`page${page.charAt(0).toUpperCase() + page.slice(1)}`).classList.remove('active-page');
            });

            const targetPage = document.getElementById(`page${pageId.charAt(0).toUpperCase() + pageId.slice(1)}`);
            targetPage.classList.add('active-page');
            
            // 3. Update Title Bar and FAB visibility (FAB is inside header)
            document.getElementById('pageTitle').textContent = PAGE_TITLES[pageId];
            const fab = document.getElementById('fabAddRoom');
            
            if (pageId === 'rooms') {
                fab.classList.remove('hidden');
                renderRooms(); // Re-render rooms list when navigating back
            } else {
                fab.classList.add('hidden');
            }
            
            // 4. Call specific render function
            if (pageId === 'summary') {
                renderSummaryPage();
            } else if (pageId === 'settings') {
                renderSettingsPage(); // Call specific render function for settings
            }

            // Reset scroll position on page change
            document.getElementById('app-wrapper').scrollTo(0, 0);
        }

        // --- LocalStorage Management ---

        function loadData() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                rentalData = storedData ? JSON.parse(storedData) : [];
                // Ensure every room has a 'transactions' array and new fields
                rentalData.forEach(room => {
                    if (!room.transactions) room.transactions = [];
                    if (!room.tasks) room.tasks = []; // Initialize tasks array
                    if (!room.endDate) room.endDate = '';
                    if (!room.dueDay) room.dueDay = 1;
                    if (!room.tenantName) room.tenantName = 'N/A';
                    if (!room.contractLink) room.contractLink = '';
                    
                    // Clean tasks data (ensure isComplete exists and set new fields)
                    room.tasks.forEach(task => {
                        if (typeof task.isComplete === 'undefined') task.isComplete = false;
                        if (typeof task.frequencyMonths === 'undefined') task.frequencyMonths = 0; // 0 for one-time
                        if (typeof task.lastCompletedDate === 'undefined') task.lastCompletedDate = ''; // Blank for one-time/never completed
                    });
                });
            } catch (e) {
                console.error('Error loading data from localStorage:', e);
                rentalData = []; 
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(rentalData));
                showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', false);
                renderApp(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            } catch (e) {
                console.error('Error saving data to localStorage:', e);
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ! ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå', true);
            }
        }

        // --- Core Financial Logic ---

        function calculateSummary(rooms, startDate = null, endDate = null) {
            let totalIncome = 0;
            let totalExpense = 0;
            const start = startDate ? new Date(startDate) : new Date(0);
            const end = endDate ? new Date(endDate) : new Date(Date.now());
            
            if (endDate) {
                end.setHours(23, 59, 59, 999);
            }
            start.setHours(0, 0, 0, 0);

            const roomSummaries = [];

            rooms.forEach(room => {
                let roomIncome = 0;
                let roomExpense = 0;
                
                room.transactions.forEach(t => {
                    const tDate = new Date(t.date);
                    tDate.setHours(0, 0, 0, 0); 
                    
                    if (tDate >= start && tDate <= end) {
                        if (t.type === 'income') {
                            roomIncome += t.amount;
                        } else if (t.type === 'expense') {
                            roomExpense += t.amount;
                        }
                    }
                });
                
                totalIncome += roomIncome;
                totalExpense += roomExpense;
                
                roomSummaries.push({
                    id: room.id,
                    roomNumber: room.roomNumber,
                    tenantName: room.tenantName || 'N/A',
                    rentAmount: room.rentAmount || 0,
                    totalIncome: roomIncome,
                    totalExpense: roomExpense,
                    balance: roomIncome - roomExpense
                });
            });

            return {
                totalIncome: totalIncome,
                totalExpense: totalExpense,
                balance: totalIncome - totalExpense,
                roomSummaries: roomSummaries
            };
        }

        // --- Page 1: Rooms Rendering ---

        function renderSummaryCard() {
            const summary = calculateSummary(rentalData); 
            const summaryCard = document.getElementById('summaryCard');
            
            const incomeColor = 'text-green-400';
            const expenseColor = 'text-red-400';
            const balanceColor = summary.balance >= 0 ? 'text-indigo-400' : 'text-red-400';

            summaryCard.innerHTML = `
                <div class="p-3 rounded-lg bg-gray-700 shadow-sm">
                    <p class="text-xs font-medium text-gray-400 mb-1">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</p>
                    <p class="text-lg font-bold ${incomeColor}">${formatCurrency(summary.totalIncome)}</p>
                </div>
                <div class="p-3 rounded-lg bg-gray-700 shadow-sm">
                    <p class="text-xs font-medium text-gray-400 mb-1">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                    <p class="text-lg font-bold ${expenseColor}">${formatCurrency(summary.totalExpense)}</p>
                </div>
                
                <div class="col-span-2 p-4 rounded-lg bg-gray-700 flex justify-between items-center mt-2">
                    <p class="text-sm font-medium text-gray-400">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                    <p class="text-xl font-extrabold ${balanceColor}">${formatCurrency(summary.balance)}</p>
                </div>
            `;
        }

        function renderRooms() {
            const roomList = document.getElementById('roomList');
            const noDataMessage = document.getElementById('noDataMessage');

            if (rentalData.length === 0) {
                roomList.innerHTML = '';
                noDataMessage.classList.remove('hidden');
                return;
            }

            noDataMessage.classList.add('hidden');
            
            // 1. Calculate status and priority for all rooms
            const roomsWithStatus = rentalData.map(room => {
                const status = getRoomStatus(room);
                const roomSummary = calculateSummary([room]);
                return {
                    ...room,
                    status: status,
                    balance: roomSummary.balance
                };
            });
            
            // 2. Sort rooms by priority (Highest first: Red=3, Yellow=2, Green=1, Gray=0)
            const sortedRooms = [...roomsWithStatus].sort((a, b) => {
                // Primary sort: Priority (descending)
                if (a.status.priority !== b.status.priority) {
                    return b.status.priority - a.status.priority;
                }
                // Secondary sort: Room Number (ascending)
                return a.roomNumber.localeCompare(b.roomNumber);
            });


            roomList.innerHTML = sortedRooms.map(room => {
                const status = room.status;
                const rentAmountText = formatCurrency(room.rentAmount);
                const hasContractLink = room.contractLink && room.contractLink.startsWith('http');
                
                return `
                    <div class="room-card p-4 rounded-xl shadow-app border border-gray-800 ${status.colorClass} text-white hover:shadow-lg transition duration-300">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-extrabold text-white">${room.roomNumber}</h3>
                                <p class="text-xs font-medium text-white/90">
                                    ${room.tenantName} ¬∑ ${getDueDateText(room.dueDay)}
                                </p>
                            </div>
                            <button onclick="openRoomModal('${room.id}')" class="p-2 text-white/80 hover:text-white transition rounded-full hover:bg-black/10" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                <i class="fas fa-pen text-sm"></i>
                            </button>
                        </div>
                        
                        <!-- Contract Details - NEW REQUIREMENT -->
                        <div class="text-xs text-white/80 mb-4 border-t border-b border-white/30 py-2">
                             <div class="flex justify-between items-center">
                                <span class="font-medium">‡πÄ‡∏£‡∏¥‡πà‡∏°: ${room.startDate}</span>
                                <span class="font-medium">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${room.endDate}</span>
                             </div>
                             
                             <!-- Contract Link and Transaction Button Row -->
                             <div class="flex justify-between items-center mt-1 pt-1 border-t border-white/20">
                                <span class="font-medium flex items-center">
                                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="font-bold ml-1">${status.text}</span>
                                </span>
                                
                                <div class="flex space-x-2">
                                    ${hasContractLink ? `
                                        <a href="${room.contractLink}" target="_blank" class="text-white hover:text-gray-200 transition" title="‡∏î‡∏π‡∏™‡∏±‡∏ç‡∏ç‡∏≤">
                                            <i class="fas fa-file-contract text-sm"></i> ‡∏î‡∏π‡∏™‡∏±‡∏ç‡∏ç‡∏≤
                                        </a>` : `<span class="text-white/60 text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏ô‡∏ö</span>`}
                                    <button onclick="openTaskModal('${room.id}', '${room.roomNumber}')" class="text-white hover:text-gray-200 transition" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô">
                                        <i class="fas fa-tasks text-sm"></i> ‡∏á‡∏≤‡∏ô
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Rent Amount and Transaction Button -->
                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-white/30">
                            <p class="text-base font-medium text-white/80">‡∏¢‡∏≠‡∏î‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                            <div class="flex items-center space-x-3">
                                <span class="text-xl font-extrabold text-white">
                                    +${rentAmountText}
                                </span>
                                <button onclick="openTransactionModal('${room.id}', '${room.roomNumber}')" 
                                    class="w-8 h-8 bg-white/20 hover:bg-white/30 text-white rounded-full transition duration-200 text-sm shadow-md flex items-center justify-center" title="‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°">
                                    <i class="fas fa-list-ul text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- Page 2: Summary Rendering ---

        function renderSummaryPage() {
            const summaryReport = document.getElementById('summaryReport');
            const insightBox = document.getElementById('geminiInsight');
            
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);

            const startDateInput = document.getElementById('summaryStartDate');
            const endDateInput = document.getElementById('summaryEndDate');

            if (!startDateInput.value) {
                startDateInput.value = threeMonthsAgo.toISOString().slice(0, 10);
            }
            if (!endDateInput.value) {
                endDateInput.value = today.toISOString().slice(0, 10);
            }

            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            insightBox.classList.add('hidden');

            if (rentalData.length === 0) {
                summaryReport.innerHTML = '<p class="text-center p-8 text-gray-500 card-surface rounded-xl shadow-md">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤</p>';
                return;
            }

            const sortedRooms = [...rentalData].sort((a, b) => a.roomNumber.localeCompare(b.roomNumber));
            
            summaryReport.innerHTML = sortedRooms.map(room => {
                const roomSummary = calculateSummary([room], startDate, endDate);
                const balance = roomSummary.balance;
                const balanceClass = balance >= 0 ? 'text-green-400' : 'text-red-400';

                return `
                    <div class="card-surface p-4 rounded-xl shadow-md border border-gray-700">
                        <h3 class="text-base font-bold text-indigo-400 mb-3">${room.roomNumber} - ${room.tenantName || 'N/A'}</h3>
                        
                        <div class="grid grid-cols-3 gap-3 text-center border-t border-gray-700 pt-3">
                            <div class="p-2 bg-gray-700 rounded-lg">
                                <p class="text-xs text-gray-400">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>
                                <p class="text-sm font-bold text-green-400">${formatCurrency(roomSummary.totalIncome)}</p>
                            </div>
                            <div class="p-2 bg-gray-700 rounded-lg">
                                <p class="text-xs text-gray-400">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>
                                <p class="text-sm font-bold text-red-400">${formatCurrency(roomSummary.totalExpense)}</p>
                            </div>
                            <div class="p-2 bg-gray-700 rounded-lg">
                                <p class="text-xs text-gray-400">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                                <p class="text-sm font-bold ${balanceClass}">${formatCurrency(balance)}</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3 text-right">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ${startDate} ‡∏ñ‡∏∂‡∏á ${endDate}</p>
                    </div>
                `;
            }).join('');
        }

        // --- Page 3: Settings Rendering ---
        
        function renderSettingsPage() {
            // Update the room count in the system info card
            document.getElementById('roomCountDisplay').textContent = rentalData.length;
        }

        // --- Gemini API Integration (Unchanged) ---

        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { 
                        return response;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Maximum retries reached for API call.");
        }

        async function callGeminiAPI(userQuery, systemPrompt) {
            if (!apiKey && typeof __api_key === 'undefined') {
                throw new Error("API Key is not configured.");
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else if (result.error) {
                    throw new Error(result.error.message || 'Gemini API returned an error.');
                }
                
                throw new Error('Invalid response structure from Gemini API.');

            } catch (error) {
                console.error('Gemini API Error:', error);
                throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI: ${error.message}`);
            }
        }
        
        async function analyzeFinancialsWithGemini() {
            if (rentalData.length === 0) {
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤', true);
                return;
            }

            const analyzeBtn = document.getElementById('analyzeButton');
            const analyzeBtnText = document.getElementById('analyzeBtnText');
            const analyzeLoader = document.getElementById('analyzeLoader');
            const insightBox = document.getElementById('geminiInsight');
            const insightContent = document.getElementById('insightContent');
            
            const startDate = document.getElementById('summaryStartDate').value;
            const endDate = document.getElementById('summaryEndDate').value;

            // 1. Set Loading State
            analyzeBtn.disabled = true;
            analyzeBtnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...';
            analyzeLoader.classList.remove('hidden');
            insightBox.classList.add('hidden');
            insightContent.innerHTML = '';
            
            try {
                // 2. Prepare Data and Prompt
                const summaryResult = calculateSummary(rentalData, startDate, endDate);
                const totalBalance = summaryResult.balance;
                const totalIncome = summaryResult.totalIncome;
                const totalExpense = summaryResult.totalExpense;
                
                const roomDataForPrompt = summaryResult.roomSummaries
                    .map(room => `‡∏´‡πâ‡∏≠‡∏á ${room.roomNumber} (‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤: ${room.tenantName}, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${room.rentAmount} ‡∏ö‡∏≤‡∏ó) - ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö: ${room.totalIncome} ‡∏ö‡∏≤‡∏ó, ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢: ${room.totalExpense} ‡∏ö‡∏≤‡∏ó, ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: ${room.balance} ‡∏ö‡∏≤‡∏ó`)
                    .join('\n');
                
                const userQuery = `‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${startDate} ‡∏ñ‡∏∂‡∏á ${endDate} ‡∏ô‡∏µ‡πâ:
                
                --- ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ---
                ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°: ${totalIncome} ‡∏ö‡∏≤‡∏ó
                ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${totalExpense} ‡∏ö‡∏≤‡∏ó
                ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Total Balance): ${totalBalance} ‡∏ö‡∏≤‡∏ó
                
                --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î) ---
                ${roomDataForPrompt}`;
                
                const systemPrompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤ (Property Management Financial Advisor) ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û 
                ‡∏à‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î) ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ 2 ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô: 
                1. ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Financial Status Summary): ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á 
                2. ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (Recommendations and Action Items): ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥ 2-3 ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ò‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`;

                // 3. Call API
                const resultText = await callGeminiAPI(userQuery, systemPrompt);

                // 4. Update UI with Result
                insightContent.innerHTML = convertMarkdownToHtml(resultText);
                insightBox.classList.remove('hidden');

            } catch (error) {
                showMessage(error.message, true);
                insightBox.classList.add('hidden');
            } finally {
                // 5. Reset Loading State
                analyzeBtn.disabled = false;
                analyzeBtnText.textContent = '‚ú® ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (AI)';
                analyzeLoader.classList.add('hidden');
            }
        }
        
        function convertMarkdownToHtml(markdown) {
            let html = markdown.replace(/^### (.*)$/gm, '<h4>$1</h4>');
            html = html.replace(/^## (.*)$/gm, '<h3>$1</h3>');
            html = html.replace(/^# (.*)$/gm, '<h2>$1</h2>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            let lines = markdown.split('\n');
            let inList = false;
            let finalHtml = [];

            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed.startsWith('* ') || trimmed.startsWith('- ')) {
                    if (!inList) {
                        finalHtml.push('<ul>');
                        inList = true;
                    }
                    finalHtml.push(`<li>${trimmed.substring(2).trim()}</li>`);
                } else {
                    if (inList) {
                        finalHtml.push('</ul>');
                        inList = false;
                    }
                    if (trimmed.match(/^(#|##|###)/)) {
                        finalHtml.push(trimmed);
                    } else if (trimmed) {
                        if (trimmed !== '') {
                             finalHtml.push(`<p>${trimmed}</p>`);
                        }
                    }
                }
            });

            if (inList) {
                finalHtml.push('</ul>');
            }
            
            let result = finalHtml.join('\n');
            result = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            return result;
        }

        // --- Page 3: Settings Logic (Export/Import) ---

        function exportDataToCsv() {
            const headers = [
                "Room ID", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á", "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", 
                "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤", "‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (1-31)",
                "Transaction ID", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°", 
                "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô"
            ].map(h => `"${h}"`).join(',') + '\n';
            
            let csvContent = headers;

            rentalData.forEach(room => {
                const roomDetails = [
                    `"${room.id}"`, 
                    `"${room.roomNumber}"`, 
                    `"${room.tenantName.replace(/"/g, '""') || 'N/A'}"`, 
                    room.rentAmount || 0, 
                    `"${room.startDate}"`,
                    `"${room.endDate}"`,
                    room.dueDay || 1,
                    `"${room.contractLink || ''}"` 
                ];
                
                if (!room.transactions || room.transactions.length === 0) {
                     csvContent += roomDetails.join(',') + ',"",,"",0,"","" \n';
                     return;
                }
                
                room.transactions.forEach(t => {
                    const transactionDetails = [
                        `"${t.id}"`, 
                        `"${t.type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}"`, 
                        `"${t.date}"`, 
                        t.amount, 
                        `"${t.detail.replace(/"/g, '""')}"`,
                        `"${t.proofLink || ''}"` 
                    ];
                    csvContent += roomDetails.concat(transactionDetails).join(',') + '\n';
                });
            });

            const BOM = "\uFEFF"; 
            const blob = new Blob([BOM + csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `rental_data_export_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showMessage('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', false);
        }

        function handleImportClick() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', true);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                importData(e.target.result);
            };
            reader.onerror = function() {
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', true);
            };
            reader.readAsText(file);
        }

        function importData(jsonString) {
            try {
                const importedData = JSON.parse(jsonString);
                if (Array.isArray(importedData) && importedData.every(room => room.id && room.roomNumber)) {
                    
                    openConfirmationModal(
                        '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 
                        '‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                        (confirmed) => {
                            if (confirmed) {
                                const cleanedData = importedData.map(room => ({
                                    ...room,
                                    tenantName: room.tenantName || 'N/A',
                                    rentAmount: Number(room.rentAmount) || 0,
                                    startDate: room.startDate || new Date().toISOString().slice(0, 10),
                                    endDate: room.endDate || new Date().toISOString().slice(0, 10), 
                                    dueDay: Number(room.dueDay) || 1, 
                                    contractLink: room.contractLink || '', 
                                    tasks: Array.isArray(room.tasks) ? room.tasks.map(t => ({ // Ensure tasks array is clean
                                        ...t,
                                        isComplete: typeof t.isComplete === 'undefined' ? false : t.isComplete,
                                        frequencyMonths: Number(t.frequencyMonths) || 0,
                                        lastCompletedDate: t.lastCompletedDate || ''
                                    })) : [],
                                    transactions: Array.isArray(room.transactions) ? room.transactions.map(t => ({
                                        ...t,
                                        proofLink: t.proofLink || '' 
                                    })) : []
                                }));
                                
                                rentalData = cleanedData;
                                saveData(); 
                                navigateTo('rooms'); 
                                showMessage('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', false);
                            } else {
                                showMessage('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', false);
                            }
                        },
                        true 
                    );
                    return;
                }
                throw new Error('‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            } catch (e) {
                console.error('Import error:', e);
                showMessage('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + e.message, true);
            }
        }


        // --- Room Modal Functions ---

        function openRoomModal(roomId) {
            const form = document.getElementById('roomForm');
            form.reset();
            const title = document.getElementById('roomModalTitle');
            const deleteButton = document.getElementById('deleteRoomButton');

            document.getElementById('roomIdInput').value = roomId || '';
            deleteButton.classList.add('hidden');
            
            const endDateInput = document.getElementById('endDateInput');
            const dueDayInput = document.getElementById('dueDayInput');
            const tenantNameInput = document.getElementById('tenantNameInput');
            const contractLinkInput = document.getElementById('contractLinkInput');

            if (roomId) {
                const room = rentalData.find(r => r.id === roomId);
                if (!room) return;
                
                title.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á ${room.roomNumber}`;
                document.getElementById('roomNumberInput').value = room.roomNumber;
                tenantNameInput.value = room.tenantName;
                document.getElementById('rentAmountInput').value = room.rentAmount;
                document.getElementById('startDateInput').value = room.startDate;
                
                endDateInput.value = room.endDate;
                dueDayInput.value = room.dueDay;
                contractLinkInput.value = room.contractLink;

                deleteButton.classList.remove('hidden');
            } else {
                title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('startDateInput').value = today;
                endDateInput.value = today;
                dueDayInput.value = 1;
                tenantNameInput.value = '';
                contractLinkInput.value = '';
            }

            openModal('roomModal');
        }

        function handleRoomFormSubmit(event) {
            event.preventDefault();
            
            const roomId = document.getElementById('roomIdInput').value;
            const roomNumber = document.getElementById('roomNumberInput').value.trim();
            const tenantName = document.getElementById('tenantNameInput').value.trim() || 'N/A';
            const rentAmount = parseInt(document.getElementById('rentAmountInput').value);
            const startDate = document.getElementById('startDateInput').value;
            const endDate = document.getElementById('endDateInput').value;
            const dueDay = parseInt(document.getElementById('dueDayInput').value);
            const contractLink = document.getElementById('contractLinkInput').value.trim();

            if (!roomNumber || !startDate || !endDate || !rentAmount || !dueDay || dueDay < 1 || dueDay > 31) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Due Day ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-31)', true);
                return;
            }

            if (roomId) {
                const roomIndex = rentalData.findIndex(r => r.id === roomId);
                if (roomIndex !== -1) {
                    if (rentalData.some(r => r.id !== roomId && r.roomNumber.toLowerCase() === roomNumber.toLowerCase())) {
                        showMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á ${roomNumber} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`, true);
                        return;
                    }
                    
                    rentalData[roomIndex].roomNumber = roomNumber;
                    rentalData[roomIndex].tenantName = tenantName;
                    rentalData[roomIndex].rentAmount = rentAmount;
                    rentalData[roomIndex].startDate = startDate;
                    rentalData[roomIndex].endDate = endDate;
                    rentalData[roomIndex].dueDay = dueDay;
                    rentalData[roomIndex].contractLink = contractLink;
                }
            } else {
                if (rentalData.some(r => r.roomNumber.toLowerCase() === roomNumber.toLowerCase())) {
                    showMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á ${roomNumber} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`, true);
                    return;
                }

                const newRoom = {
                    id: generateId(),
                    roomNumber: roomNumber,
                    tenantName: tenantName,
                    rentAmount: rentAmount,
                    startDate: startDate,
                    endDate: endDate, 
                    dueDay: dueDay, 
                    contractLink: contractLink,
                    tasks: [], 
                    transactions: []
                };
                rentalData.push(newRoom);
            }

            saveData();
            closeModal('roomModal');
        }
        
        function requestDeleteRoom() {
            const roomId = document.getElementById('roomIdInput').value;
            if (!roomId) return;
            const room = rentalData.find(r => r.id === roomId);
            
            openConfirmationModal(
                '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á', 
                `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á ${room.roomNumber} (${room.tenantName})? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢!`,
                (confirmed) => {
                    if (confirmed) {
                        rentalData = rentalData.filter(r => r.id !== roomId);
                        saveData();
                        closeModal('roomModal');
                        navigateTo('rooms'); 
                    }
                }
            );
        }

        // --- Transaction Modal Functions (Unchanged) ---

        function openTransactionModal(roomId, roomNumber) {
            currentRoomId = roomId;
            const title = document.getElementById('transactionModalTitle');
            const dateInput = document.getElementById('transactionDateInput');
            
            title.textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ${roomNumber}`;
            document.getElementById('transactionRoomIdInput').value = roomId;
            dateInput.valueAsDate = new Date();
            
            renderTransactions(roomId);

            openModal('transactionModal');
        }

        function handleTransactionFormSubmit(event) {
            event.preventDefault();
            
            const roomId = document.getElementById('transactionRoomIdInput').value;
            const type = document.getElementById('transactionTypeInput').value;
            const date = document.getElementById('transactionDateInput').value;
            const amount = parseInt(document.getElementById('transactionAmountInput').value);
            const detail = document.getElementById('transactionDetailInput').value.trim();
            const proofLink = document.getElementById('proofLinkInput').value.trim();

            if (!roomId || isNaN(amount) || amount <= 0) {
                 showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);
                 return;
            }

            const roomIndex = rentalData.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;

            const newTransaction = {
                id: generateId(),
                type: type,
                date: date,
                amount: amount,
                detail: detail,
                proofLink: proofLink
            };

            rentalData[roomIndex].transactions.push(newTransaction);
            document.getElementById('transactionForm').reset(); 
            document.getElementById('transactionDateInput').valueAsDate = new Date(); 

            saveData(); 
            renderTransactions(roomId); 
        }

        function requestDeleteTransaction(roomId, transactionId) {
            openConfirmationModal(
                '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 
                '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ?',
                (confirmed) => {
                    if (confirmed) {
                        const roomIndex = rentalData.findIndex(r => r.id === roomId);
                        if (roomIndex !== -1) {
                            rentalData[roomIndex].transactions = rentalData[roomIndex].transactions.filter(t => t.id !== transactionId);
                            saveData();
                            renderTransactions(roomId); 
                            showMessage('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
                        }
                    }
                }
            );
        }
        
        function renderTransactions(roomId) {
            const room = rentalData.find(r => r.id === roomId);
            const transactionList = document.getElementById('transactionList');
            
            if (!room || room.transactions.length === 0) {
                transactionList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-gray-700 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>';
                return;
            }

            const sortedTransactions = room.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            transactionList.innerHTML = sortedTransactions.map(t => {
                const isIncome = t.type === 'income';
                const colorClass = isIncome ? 'text-green-400' : 'text-red-400';
                const sign = isIncome ? '+' : '-';
                const detailText = t.detail && t.detail.trim() !== '' ? t.detail : (isIncome ? '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
                const icon = isIncome ? 'fa-arrow-down' : 'fa-arrow-up';
                const hasLink = t.proofLink && t.proofLink.startsWith('http');

                return `
                    <div class="flex justify-between items-center p-3 rounded-xl border border-gray-700 bg-gray-800 shadow-sm hover:shadow-md transition duration-200">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-200">${detailText}</span>
                            <span class="text-xs text-gray-400 mt-0.5"><i class="fas fa-calendar-day mr-1"></i> ${t.date}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            ${hasLink ? `<a href="${t.proofLink}" target="_blank" class="text-indigo-400 hover:text-indigo-300 p-1 rounded-full hover:bg-gray-700" title="‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞"><i class="fas fa-link text-sm"></i></a>` : ''}
                            <span class="font-bold ${colorClass} text-sm flex items-center">
                                <i class="fas ${icon} text-xs mr-2 ${isIncome ? 'text-green-500' : 'text-red-500'}"></i>
                                ${sign} ${formatCurrency(t.amount)}
                            </span>
                            <button onclick="requestDeleteTransaction('${roomId}', '${t.id}')" class="text-red-400 hover:text-red-300 p-1 rounded-full hover:bg-gray-700" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- Task Modal Functions (CRUD) ---

        // Helper: Calculate next deadline based on last completed date
        function getNextDeadline(lastCompletedDate, frequencyMonths) {
            if (!lastCompletedDate || frequencyMonths === 0) return new Date(); // Return current date if invalid/one-time
            
            const lastDate = new Date(lastCompletedDate);
            const nextDate = new Date(lastDate);
            nextDate.setMonth(lastDate.getMonth() + frequencyMonths);
            
            return nextDate;
        }

        function toggleTaskDeadline() {
            const frequency = document.getElementById('taskFrequencyInput').value;
            const deadlineLabel = document.getElementById('taskDeadlineLabel');
            const lastCompletedGroup = document.getElementById('lastCompletedGroup');
            
            if (frequency === '0') {
                deadlineLabel.textContent = '‡∏ß‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)';
                lastCompletedGroup.classList.add('hidden');
            } else {
                deadlineLabel.textContent = '‡∏ß‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ)';
                lastCompletedGroup.classList.remove('hidden');
            }
        }

        function openTaskModal(roomId, roomNumber) {
            currentRoomId = roomId;
            const title = document.getElementById('taskModalTitle');
            const dateInput = document.getElementById('taskDeadlineInput');
            
            title.textContent = `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ${roomNumber}`;
            document.getElementById('taskRoomIdInput').value = roomId;
            
            // Set defaults for new task form
            document.getElementById('taskForm').reset();
            document.getElementById('taskFrequencyInput').value = '0';
            document.getElementById('taskDeadlineInput').valueAsDate = new Date();
            document.getElementById('taskLastCompletedInput').value = new Date().toISOString().slice(0, 10);
            toggleTaskDeadline(); // Set visibility for one-time task defaults
            
            renderTasks(roomId);
            openModal('taskModal');
        }

        function renderTasks(roomId) {
            const room = rentalData.find(r => r.id === roomId);
            const taskList = document.getElementById('taskList');
            
            if (!room || room.tasks.length === 0) {
                taskList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-gray-700 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</p>';
                return;
            }

            const sortedTasks = [...room.tasks].sort((a, b) => {
                const dateA = a.frequencyMonths > 0 ? getNextDeadline(a.lastCompletedDate, a.frequencyMonths) : new Date(a.deadline);
                const dateB = b.frequencyMonths > 0 ? getNextDeadline(b.lastCompletedDate, b.frequencyMonths) : new Date(b.deadline);
                
                const aOverdue = !a.isComplete && dateA < new Date();
                const bOverdue = !b.isComplete && dateB < new Date();

                if (aOverdue !== bOverdue) return bOverdue - aOverdue; 
                if (a.isComplete !== b.isComplete) return a.isComplete - b.isComplete;
                return dateA - dateB; 
            });

            taskList.innerHTML = sortedTasks.map(task => {
                const isComplete = task.isComplete;
                
                // Calculate actual deadline/next due date
                const actualDeadline = task.frequencyMonths > 0 && task.lastCompletedDate
                    ? getNextDeadline(task.lastCompletedDate, task.frequencyMonths)
                    : new Date(task.deadline);
                
                const isOverdue = !isComplete && actualDeadline < new Date();
                
                const dotClass = isComplete ? 'task-dot-complete' : (isOverdue ? 'task-dot-overdue' : 'task-dot-pending');
                const textClass = isComplete ? 'text-gray-500 line-through' : (isOverdue ? 'text-red-400 font-medium' : 'text-gray-200');
                const deadlineText = actualDeadline.toISOString().slice(0, 10);

                return `
                    <div class="flex justify-between items-center p-3 rounded-xl border border-gray-700 bg-gray-800 shadow-sm">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <input type="checkbox" ${isComplete ? 'checked' : ''} 
                                onclick="toggleTaskCompletion('${roomId}', '${task.id}')"
                                class="h-5 w-5 rounded-md text-indigo-500 focus:ring-indigo-500 bg-gray-600 border-gray-500 cursor-pointer">
                            
                            <div class="flex flex-col min-w-0 flex-1">
                                <span class="text-sm ${textClass} truncate">${task.detail}</span>
                                <span class="text-xs text-gray-400 flex items-center mt-0.5">
                                    <span class="task-status-dot ${dotClass}"></span>
                                    ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${deadlineText} 
                                    ${task.frequencyMonths > 0 ? `<span class="ml-2 italic text-gray-500"> (‡∏ó‡∏∏‡∏Å ${task.frequencyMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</span>` : ''}
                                </span>
                            </div>
                        </div>
                        <button onclick="requestDeleteTask('${roomId}', '${task.id}')" class="text-red-400 hover:text-red-300 p-1 rounded-full hover:bg-gray-700 ml-2" title="‡∏•‡∏ö‡∏á‡∏≤‡∏ô">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function handleTaskFormSubmit(event) {
            event.preventDefault();
            
            const roomId = document.getElementById('taskRoomIdInput').value;
            const detail = document.getElementById('taskDetailInput').value.trim();
            const frequencyMonths = parseInt(document.getElementById('taskFrequencyInput').value);
            let deadline = document.getElementById('taskDeadlineInput').value;
            let lastCompletedDate = document.getElementById('taskLastCompletedInput').value;

            if (frequencyMonths > 0 && !lastCompletedDate) {
                 showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥', true);
                 return;
            }
            if (frequencyMonths === 0) {
                 lastCompletedDate = ''; // Clear completed date for one-time tasks
            } else {
                 // Calculate next deadline if it's a recurring task
                 deadline = getNextDeadline(lastCompletedDate, frequencyMonths).toISOString().slice(0, 10);
            }

            const roomIndex = rentalData.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;

            const newTask = {
                id: generateId(),
                detail: detail,
                deadline: deadline,
                isComplete: false, 
                frequencyMonths: frequencyMonths,
                lastCompletedDate: lastCompletedDate
            };

            rentalData[roomIndex].tasks.push(newTask);
            document.getElementById('taskForm').reset(); 
            document.getElementById('taskDeadlineInput').valueAsDate = new Date(); 

            saveData(); 
            renderTasks(roomId); 
        }

        function toggleTaskCompletion(roomId, taskId) {
            const roomIndex = rentalData.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;
            
            const task = rentalData[roomIndex].tasks.find(t => t.id === taskId);
            if (task) {
                // If the task is being marked COMPLETE
                if (!task.isComplete) {
                    if (task.frequencyMonths > 0) {
                         // For recurring tasks, record completion date
                        task.lastCompletedDate = new Date().toISOString().slice(0, 10);
                        task.isComplete = false; // Stay false to recalculate and show next deadline as pending
                    } else {
                         // For one-time tasks, just mark complete
                         task.isComplete = true;
                    }
                } else {
                    // If task is being marked PENDING (un-completed)
                    task.isComplete = false;
                    if (task.frequencyMonths > 0) {
                         // Clear last completed date if un-completing a recurring task
                         task.lastCompletedDate = '';
                    }
                }

                saveData();
                renderTasks(roomId);
            }
        }
        
        function requestDeleteTask(roomId, taskId) {
             openConfirmationModal(
                '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô', 
                '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?',
                (confirmed) => {
                    if (confirmed) {
                        const roomIndex = rentalData.findIndex(r => r.id === roomId);
                        if (roomIndex !== -1) {
                            rentalData[roomIndex].tasks = rentalData[roomIndex].tasks.filter(t => t.id !== taskId);
                            saveData();
                            renderTasks(roomId); 
                            showMessage('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
                        }
                    }
                }
            );
        }
        
        // --- Room Modal Functions (Unchanged) ---

        function openRoomModal(roomId) {
            const form = document.getElementById('roomForm');
            form.reset();
            const title = document.getElementById('roomModalTitle');
            const deleteButton = document.getElementById('deleteRoomButton');

            document.getElementById('roomIdInput').value = roomId || '';
            deleteButton.classList.add('hidden');
            
            const endDateInput = document.getElementById('endDateInput');
            const dueDayInput = document.getElementById('dueDayInput');
            const tenantNameInput = document.getElementById('tenantNameInput');
            const contractLinkInput = document.getElementById('contractLinkInput');

            if (roomId) {
                const room = rentalData.find(r => r.id === roomId);
                if (!room) return;
                
                title.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á ${room.roomNumber}`;
                document.getElementById('roomNumberInput').value = room.roomNumber;
                tenantNameInput.value = room.tenantName;
                document.getElementById('rentAmountInput').value = room.rentAmount;
                document.getElementById('startDateInput').value = room.startDate;
                
                endDateInput.value = room.endDate;
                dueDayInput.value = room.dueDay;
                contractLinkInput.value = room.contractLink;

                deleteButton.classList.remove('hidden');
            } else {
                title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('startDateInput').value = today;
                endDateInput.value = today;
                dueDayInput.value = 1;
                tenantNameInput.value = '';
                contractLinkInput.value = '';
            }

            openModal('roomModal');
        }

        function handleRoomFormSubmit(event) {
            event.preventDefault();
            
            const roomId = document.getElementById('roomIdInput').value;
            const roomNumber = document.getElementById('roomNumberInput').value.trim();
            const tenantName = document.getElementById('tenantNameInput').value.trim() || 'N/A';
            const rentAmount = parseInt(document.getElementById('rentAmountInput').value);
            const startDate = document.getElementById('startDateInput').value;
            const endDate = document.getElementById('endDateInput').value;
            const dueDay = parseInt(document.getElementById('dueDayInput').value);
            const contractLink = document.getElementById('contractLinkInput').value.trim();

            if (!roomNumber || !startDate || !endDate || !rentAmount || !dueDay || dueDay < 1 || dueDay > 31) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Due Day ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-31)', true);
                return;
            }

            if (roomId) {
                const roomIndex = rentalData.findIndex(r => r.id === roomId);
                if (roomIndex !== -1) {
                    if (rentalData.some(r => r.id !== roomId && r.roomNumber.toLowerCase() === roomNumber.toLowerCase())) {
                        showMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á ${roomNumber} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`, true);
                        return;
                    }
                    
                    rentalData[roomIndex].roomNumber = roomNumber;
                    rentalData[roomIndex].tenantName = tenantName;
                    rentalData[roomIndex].rentAmount = rentAmount;
                    rentalData[roomIndex].startDate = startDate;
                    rentalData[roomIndex].endDate = endDate;
                    rentalData[roomIndex].dueDay = dueDay;
                    rentalData[roomIndex].contractLink = contractLink;
                }
            } else {
                if (rentalData.some(r => r.roomNumber.toLowerCase() === roomNumber.toLowerCase())) {
                    showMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á ${roomNumber} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`, true);
                    return;
                }

                const newRoom = {
                    id: generateId(),
                    roomNumber: roomNumber,
                    tenantName: tenantName,
                    rentAmount: rentAmount,
                    startDate: startDate,
                    endDate: endDate, 
                    dueDay: dueDay, 
                    contractLink: contractLink,
                    tasks: [], 
                    transactions: []
                };
                rentalData.push(newRoom);
            }

            saveData();
            closeModal('roomModal');
        }
        
        function requestDeleteRoom() {
            const roomId = document.getElementById('roomIdInput').value;
            if (!roomId) return;
            const room = rentalData.find(r => r.id === roomId);
            
            openConfirmationModal(
                '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á', 
                `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á ${room.roomNumber} (${room.tenantName})? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢!`,
                (confirmed) => {
                    if (confirmed) {
                        rentalData = rentalData.filter(r => r.id !== roomId);
                        saveData();
                        closeModal('roomModal');
                        navigateTo('rooms'); 
                    }
                }
            );
        }

        // --- Transaction Modal Functions (Unchanged) ---

        function openTransactionModal(roomId, roomNumber) {
            currentRoomId = roomId;
            const title = document.getElementById('transactionModalTitle');
            const dateInput = document.getElementById('transactionDateInput');
            
            title.textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ${roomNumber}`;
            document.getElementById('transactionRoomIdInput').value = roomId;
            dateInput.valueAsDate = new Date();
            
            renderTransactions(roomId);

            openModal('transactionModal');
        }

        function handleTransactionFormSubmit(event) {
            event.preventDefault();
            
            const roomId = document.getElementById('transactionRoomIdInput').value;
            const type = document.getElementById('transactionTypeInput').value;
            const date = document.getElementById('transactionDateInput').value;
            const amount = parseInt(document.getElementById('transactionAmountInput').value);
            const detail = document.getElementById('transactionDetailInput').value.trim();
            const proofLink = document.getElementById('proofLinkInput').value.trim();

            if (!roomId || isNaN(amount) || amount <= 0) {
                 showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);
                 return;
            }

            const roomIndex = rentalData.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;

            const newTransaction = {
                id: generateId(),
                type: type,
                date: date,
                amount: amount,
                detail: detail,
                proofLink: proofLink
            };

            rentalData[roomIndex].transactions.push(newTransaction);
            document.getElementById('transactionForm').reset(); 
            document.getElementById('transactionDateInput').valueAsDate = new Date(); 

            saveData(); 
            renderTransactions(roomId); 
        }

        function requestDeleteTransaction(roomId, transactionId) {
            openConfirmationModal(
                '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 
                '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ?',
                (confirmed) => {
                    if (confirmed) {
                        const roomIndex = rentalData.findIndex(r => r.id === roomId);
                        if (roomIndex !== -1) {
                            rentalData[roomIndex].transactions = rentalData[roomIndex].transactions.filter(t => t.id !== transactionId);
                            saveData();
                            renderTransactions(roomId); 
                            showMessage('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
                        }
                    }
                }
            );
        }
        
        function renderTransactions(roomId) {
            const room = rentalData.find(r => r.id === roomId);
            const transactionList = document.getElementById('transactionList');
            
            if (!room || room.transactions.length === 0) {
                transactionList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-gray-700 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>';
                return;
            }

            const sortedTransactions = room.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            transactionList.innerHTML = sortedTransactions.map(t => {
                const isIncome = t.type === 'income';
                const colorClass = isIncome ? 'text-green-400' : 'text-red-400';
                const sign = isIncome ? '+' : '-';
                const detailText = t.detail && t.detail.trim() !== '' ? t.detail : (isIncome ? '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
                const icon = isIncome ? 'fa-arrow-down' : 'fa-arrow-up';
                const hasLink = t.proofLink && t.proofLink.startsWith('http');

                return `
                    <div class="flex justify-between items-center p-3 rounded-xl border border-gray-700 bg-gray-800 shadow-sm hover:shadow-md transition duration-200">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-200">${detailText}</span>
                            <span class="text-xs text-gray-400 mt-0.5"><i class="fas fa-calendar-day mr-1"></i> ${t.date}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            ${hasLink ? `<a href="${t.proofLink}" target="_blank" class="text-indigo-400 hover:text-indigo-300 p-1 rounded-full hover:bg-gray-700" title="‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞"><i class="fas fa-link text-sm"></i></a>` : ''}
                            <span class="font-bold ${colorClass} text-sm flex items-center">
                                <i class="fas ${icon} text-xs mr-2 ${isIncome ? 'text-green-500' : 'text-red-500'}"></i>
                                ${sign} ${formatCurrency(t.amount)}
                            </span>
                            <button onclick="requestDeleteTransaction('${roomId}', '${t.id}')" class="text-red-400 hover:text-red-300 p-1 rounded-full hover:bg-gray-700" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- Task Modal Functions (CRUD) ---

        // Helper: Calculate next deadline based on last completed date
        function getNextDeadline(lastCompletedDate, frequencyMonths) {
            if (!lastCompletedDate || frequencyMonths === 0) return new Date();
            
            const lastDate = new Date(lastCompletedDate);
            const nextDate = new Date(lastDate);
            nextDate.setMonth(lastDate.getMonth() + frequencyMonths);
            
            // Format to YYYY-MM-DD
            return new Date(nextDate.getTime() - (nextDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
        }

        function toggleTaskDeadline() {
            const frequency = document.getElementById('taskFrequencyInput').value;
            const deadlineLabel = document.getElementById('taskDeadlineLabel');
            const lastCompletedGroup = document.getElementById('lastCompletedGroup');
            const deadlineInput = document.getElementById('taskDeadlineInput');
            
            if (frequency === '0') {
                deadlineLabel.textContent = '‡∏ß‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)';
                lastCompletedGroup.classList.add('hidden');
                deadlineInput.required = true;
            } else {
                deadlineLabel.textContent = '‡∏ß‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ)';
                lastCompletedGroup.classList.remove('hidden');
                document.getElementById('taskLastCompletedInput').required = true;
                deadlineInput.required = false; // Deadline is calculated, not directly entered
            }
        }

        function openTaskModal(roomId, roomNumber) {
            currentRoomId = roomId;
            const title = document.getElementById('taskModalTitle');
            
            title.textContent = `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ${roomNumber}`;
            document.getElementById('taskRoomIdInput').value = roomId;
            
            // Set defaults for new task form
            document.getElementById('taskForm').reset();
            document.getElementById('taskFrequencyInput').value = '0';
            document.getElementById('taskDeadlineInput').valueAsDate = new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)); // Default 30 days out
            document.getElementById('taskLastCompletedInput').value = new Date().toISOString().slice(0, 10);
            toggleTaskDeadline(); // Set visibility for one-time task defaults
            
            renderTasks(roomId);
            openModal('taskModal');
        }

        function renderTasks(roomId) {
            const room = rentalData.find(r => r.id === roomId);
            const taskList = document.getElementById('taskList');
            
            if (!room || room.tasks.length === 0) {
                taskList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-gray-700 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</p>';
                return;
            }

            const sortedTasks = [...room.tasks].sort((a, b) => {
                const dateA = a.frequencyMonths > 0 ? new Date(getNextDeadline(a.lastCompletedDate, a.frequencyMonths)) : new Date(a.deadline);
                const dateB = b.frequencyMonths > 0 ? new Date(getNextDeadline(b.lastCompletedDate, b.frequencyMonths)) : new Date(b.deadline);
                
                const aOverdue = !a.isComplete && dateA < new Date();
                const bOverdue = !b.isComplete && dateB < new Date();

                if (aOverdue !== bOverdue) return bOverdue - aOverdue; 
                if (a.isComplete !== b.isComplete) return a.isComplete - b.isComplete;
                return dateA - dateB; 
            });

            taskList.innerHTML = sortedTasks.map(task => {
                const isComplete = task.isComplete;
                
                const actualDeadlineDate = task.frequencyMonths > 0 && task.lastCompletedDate
                    ? getNextDeadline(task.lastCompletedDate, task.frequencyMonths)
                    : task.deadline; // Already a YYYY-MM-DD string for one-time tasks

                const actualDeadline = new Date(actualDeadlineDate);
                const isOverdue = !isComplete && actualDeadline < new Date();
                
                const dotClass = isComplete ? 'task-dot-complete' : (isOverdue ? 'task-dot-overdue' : 'task-dot-pending');
                const textClass = isComplete ? 'text-gray-500 line-through' : (isOverdue ? 'text-red-400 font-medium' : 'text-gray-200');
                const deadlineText = actualDeadlineDate;
                const lastDateText = task.lastCompletedDate ? ` (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${task.lastCompletedDate})` : '';

                return `
                    <div class="flex justify-between items-center p-3 rounded-xl border border-gray-700 bg-gray-800 shadow-sm">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <input type="checkbox" ${isComplete ? 'checked' : ''} 
                                onclick="toggleTaskCompletion('${roomId}', '${task.id}')"
                                class="h-5 w-5 rounded-md text-indigo-500 focus:ring-indigo-500 bg-gray-600 border-gray-500 cursor-pointer">
                            
                            <div class="flex flex-col min-w-0 flex-1">
                                <span class="text-sm ${textClass} truncate">${task.detail}</span>
                                <span class="text-xs text-gray-400 flex items-center mt-0.5">
                                    <span class="task-status-dot ${dotClass}"></span>
                                    ${isComplete ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î:'} ${deadlineText} 
                                    ${task.frequencyMonths > 0 ? `<span class="ml-2 italic text-gray-500"> (‡∏ó‡∏∏‡∏Å ${task.frequencyMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)${lastDateText}</span>` : ''}
                                </span>
                            </div>
                        </div>
                        <button onclick="requestDeleteTask('${roomId}', '${task.id}')" class="text-red-400 hover:text-red-300 p-1 rounded-full hover:bg-gray-700 ml-2" title="‡∏•‡∏ö‡∏á‡∏≤‡∏ô">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function handleTaskFormSubmit(event) {
            event.preventDefault();
            
            const roomId = document.getElementById('taskRoomIdInput').value;
            const detail = document.getElementById('taskDetailInput').value.trim();
            const frequencyMonths = parseInt(document.getElementById('taskFrequencyInput').value);
            let deadline = document.getElementById('taskDeadlineInput').value;
            let lastCompletedDate = document.getElementById('taskLastCompletedInput').value;

            if (frequencyMonths > 0 && !lastCompletedDate) {
                 showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥', true);
                 return;
            }
            
            if (frequencyMonths === 0) {
                 lastCompletedDate = '';
                 // Deadline is used directly from input
            } else {
                 // For recurring task, calculate next deadline based on last completed date
                 deadline = getNextDeadline(lastCompletedDate, frequencyMonths);
                 // We don't need the deadline input value, but the calculated date
            }
            
            const roomIndex = rentalData.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;

            const newTask = {
                id: generateId(),
                detail: detail,
                deadline: deadline,
                isComplete: false, 
                frequencyMonths: frequencyMonths,
                lastCompletedDate: lastCompletedDate
            };

            rentalData[roomIndex].tasks.push(newTask);
            document.getElementById('taskForm').reset(); 
            document.getElementById('taskDeadlineInput').valueAsDate = new Date(); 

            saveData(); 
            renderTasks(roomId); 
        }

        function toggleTaskCompletion(roomId, taskId) {
            const roomIndex = rentalData.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;
            
            const task = rentalData[roomIndex].tasks.find(t => t.id === taskId);
            if (task) {
                // If the task is being marked COMPLETE
                if (!task.isComplete) {
                    if (task.frequencyMonths > 0) {
                         // For recurring tasks, update completion date and keep isComplete=false for next cycle check
                        task.lastCompletedDate = new Date().toISOString().slice(0, 10);
                        task.deadline = getNextDeadline(task.lastCompletedDate, task.frequencyMonths);
                        task.isComplete = false;
                        showMessage(`‡∏á‡∏≤‡∏ô "${task.detail}" ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${task.deadline}`, false);
                    } else {
                         // For one-time tasks, just mark complete
                         task.isComplete = true;
                         showMessage(`‡∏á‡∏≤‡∏ô "${task.detail}" ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô`, false);
                    }
                } else {
                    // If task is being marked PENDING (un-completed)
                    task.isComplete = false;
                    if (task.frequencyMonths > 0) {
                         // If un-completing a recurring task, you might revert the last completed date manually in a real app, 
                         // but here we just revert the flag/status for simplicity.
                         // For simplicity, we just mark it incomplete and allow the system to flag it as overdue if applicable.
                         // Or, we could remove the last completed date to force user to re-enter it, but let's keep it simple.
                    }
                }

                saveData();
                renderTasks(roomId);
            }
        }
        
        function requestDeleteTask(roomId, taskId) {
             openConfirmationModal(
                '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô', 
                '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?',
                (confirmed) => {
                    if (confirmed) {
                        const roomIndex = rentalData.findIndex(r => r.id === roomId);
                        if (roomIndex !== -1) {
                            rentalData[roomIndex].tasks = rentalData[roomIndex].tasks.filter(t => t.id !== taskId);
                            saveData();
                            renderTasks(roomId); 
                            showMessage('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
                        }
                    }
                }
            );
        }
        
        // --- Room Modal Functions (Unchanged) ---

        function openRoomModal(roomId) {
            const form = document.getElementById('roomForm');
            form.reset();
            const title = document.getElementById('roomModalTitle');
            const deleteButton = document.getElementById('deleteRoomButton');

            document.getElementById('roomIdInput').value = roomId || '';
            deleteButton.classList.add('hidden');
            
            const endDateInput = document.getElementById('endDateInput');
            const dueDayInput = document.getElementById('dueDayInput');
            const tenantNameInput = document.getElementById('tenantNameInput');
            const contractLinkInput = document.getElementById('contractLinkInput');

            if (roomId) {
                const room = rentalData.find(r => r.id === roomId);
                if (!room) return;
                
                title.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á ${room.roomNumber}`;
                document.getElementById('roomNumberInput').value = room.roomNumber;
                tenantNameInput.value = room.tenantName;
                document.getElementById('rentAmountInput').value = room.rentAmount;
                document.getElementById('startDateInput').value = room.startDate;
                
                endDateInput.value = room.endDate;
                dueDayInput.value = room.dueDay;
                contractLinkInput.value = room.contractLink;

                deleteButton.classList.remove('hidden');
            } else {
                title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('startDateInput').value = today;
                endDateInput.value = today;
                dueDayInput.value = 1;
                tenantNameInput.value = '';
                contractLinkInput.value = '';
            }

            openModal('roomModal');
        }

        function handleRoomFormSubmit(event) {
            event.preventDefault();
            
            const roomId = document.getElementById('roomIdInput').value;
            const roomNumber = document.getElementById('roomNumberInput').value.trim();
            const tenantName = document.getElementById('tenantNameInput').value.trim() || 'N/A';
            const rentAmount = parseInt(document.getElementById('rentAmountInput').value);
            const startDate = document.getElementById('startDateInput').value;
            const endDate = document.getElementById('endDateInput').value;
            const dueDay = parseInt(document.getElementById('dueDayInput').value);
            const contractLink = document.getElementById('contractLinkInput').value.trim();

            if (!roomNumber || !startDate || !endDate || !rentAmount || !dueDay || dueDay < 1 || dueDay > 31) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Due Day ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-31)', true);
                return;
            }

            if (roomId) {
                const roomIndex = rentalData.findIndex(r => r.id === roomId);
                if (roomIndex !== -1) {
                    if (rentalData.some(r => r.id !== roomId && r.roomNumber.toLowerCase() === roomNumber.toLowerCase())) {
                        showMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á ${roomNumber} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`, true);
                        return;
                    }
                    
                    rentalData[roomIndex].roomNumber = roomNumber;
                    rentalData[roomIndex].tenantName = tenantName;
                    rentalData[roomIndex].rentAmount = rentAmount;
                    rentalData[roomIndex].startDate = startDate;
                    rentalData[roomIndex].endDate = endDate;
                    rentalData[roomIndex].dueDay = dueDay;
                    rentalData[roomIndex].contractLink = contractLink;
                }
            } else {
                if (rentalData.some(r => r.roomNumber.toLowerCase() === roomNumber.toLowerCase())) {
                    showMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á ${roomNumber} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`, true);
                    return;
                }

                const newRoom = {
                    id: generateId(),
                    roomNumber: roomNumber,
                    tenantName: tenantName,
                    rentAmount: rentAmount,
                    startDate: startDate,
                    endDate: endDate, 
                    dueDay: dueDay, 
                    contractLink: contractLink,
                    tasks: [], 
                    transactions: []
                };
                rentalData.push(newRoom);
            }

            saveData();
            closeModal('roomModal');
        }
        
        function requestDeleteRoom() {
            const roomId = document.getElementById('roomIdInput').value;
            if (!roomId) return;
            const room = rentalData.find(r => r.id === roomId);
            
            openConfirmationModal(
                '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á', 
                `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á ${room.roomNumber} (${room.tenantName})? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢!`,
                (confirmed) => {
                    if (confirmed) {
                        rentalData = rentalData.filter(r => r.id !== roomId);
                        saveData();
                        closeModal('roomModal');
                        navigateTo('rooms'); 
                    }
                }
            );
        }

        // --- Transaction Modal Functions (Unchanged) ---

        function openTransactionModal(roomId, roomNumber) {
            currentRoomId = roomId;
            const title = document.getElementById('transactionModalTitle');
            const dateInput = document.getElementById('transactionDateInput');
            
            title.textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ${roomNumber}`;
            document.getElementById('transactionRoomIdInput').value = roomId;
            dateInput.valueAsDate = new Date();
            
            renderTransactions(roomId);

            openModal('transactionModal');
        }

        function handleTransactionFormSubmit(event) {
            event.preventDefault();
            
            const roomId = document.getElementById('transactionRoomIdInput').value;
            const type = document.getElementById('transactionTypeInput').value;
            const date = document.getElementById('transactionDateInput').value;
            const amount = parseInt(document.getElementById('transactionAmountInput').value);
            const detail = document.getElementById('transactionDetailInput').value.trim();
            const proofLink = document.getElementById('proofLinkInput').value.trim();

            if (!roomId || isNaN(amount) || amount <= 0) {
                 showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);
                 return;
            }

            const roomIndex = rentalData.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;

            const newTransaction = {
                id: generateId(),
                type: type,
                date: date,
                amount: amount,
                detail: detail,
                proofLink: proofLink
            };

            rentalData[roomIndex].transactions.push(newTransaction);
            document.getElementById('transactionForm').reset(); 
            document.getElementById('transactionDateInput').valueAsDate = new Date(); 

            saveData(); 
            renderTransactions(roomId); 
        }

        function requestDeleteTransaction(roomId, transactionId) {
            openConfirmationModal(
                '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 
                '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ?',
                (confirmed) => {
                    if (confirmed) {
                        const roomIndex = rentalData.findIndex(r => r.id === roomId);
                        if (roomIndex !== -1) {
                            rentalData[roomIndex].transactions = rentalData[roomIndex].transactions.filter(t => t.id !== transactionId);
                            saveData();
                            renderTransactions(roomId); 
                            showMessage('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
                        }
                    }
                }
            );
        }
        
        function renderTransactions(roomId) {
            const room = rentalData.find(r => r.id === roomId);
            const transactionList = document.getElementById('transactionList');
            
            if (!room || room.transactions.length === 0) {
                transactionList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-gray-700 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>';
                return;
            }

            const sortedTransactions = room.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            transactionList.innerHTML = sortedTransactions.map(t => {
                const isIncome = t.type === 'income';
                const colorClass = isIncome ? 'text-green-400' : 'text-red-400';
                const sign = isIncome ? '+' : '-';
                const detailText = t.detail && t.detail.trim() !== '' ? t.detail : (isIncome ? '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
                const icon = isIncome ? 'fa-arrow-down' : 'fa-arrow-up';
                const hasLink = t.proofLink && t.proofLink.startsWith('http');

                return `
                    <div class="flex justify-between items-center p-3 rounded-xl border border-gray-700 bg-gray-800 shadow-sm hover:shadow-md transition duration-200">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-200">${detailText}</span>
                            <span class="text-xs text-gray-400 mt-0.5"><i class="fas fa-calendar-day mr-1"></i> ${t.date}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            ${hasLink ? `<a href="${t.proofLink}" target="_blank" class="text-indigo-400 hover:text-indigo-300 p-1 rounded-full hover:bg-gray-700" title="‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞"><i class="fas fa-link text-sm"></i></a>` : ''}
                            <span class="font-bold ${colorClass} text-sm flex items-center">
                                <i class="fas ${icon} text-xs mr-2 ${isIncome ? 'text-green-500' : 'text-red-500'}"></i>
                                ${sign} ${formatCurrency(t.amount)}
                            </span>
                            <button onclick="requestDeleteTransaction('${roomId}', '${t.id}')" class="text-red-400 hover:text-red-300 p-1 rounded-full hover:bg-gray-700" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // --- Initialization ---

        function renderApp() {
            renderSummaryCard();
            
            if (document.getElementById('pageRooms').classList.contains('active-page')) {
                renderRooms();
            } else if (document.getElementById('pageSummary').classList.contains('active-page')) {
                renderSummaryPage();
            } else if (document.getElementById('pageSettings').classList.contains('active-page')) {
                 renderSettingsPage(); // Ensure settings page is updated
            }
        }

        window.onload = function() {
            // Attach Confirmation Modal Listeners
            document.getElementById('confirmCancelBtn').onclick = () => closeConfirmationModal(false); 
            document.getElementById('confirmOkBtn').onclick = () => closeConfirmationModal(true);
            
            // Set initial date range for Summary
            const today = new Date().toISOString().slice(0, 10);
            const threeMonthsAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
            document.getElementById('summaryEndDate').value = today;
            document.getElementById('summaryStartDate').value = threeMonthsAgo;

            loadData();
            // Start on the Rooms page and initialize rendering
            navigateTo('rooms');
        };
        
        // --- Run Self Check / Debug Function ---
        function runSelfCheck() {
            // This function runs on click and updates the System Info Card
            const roomCountDisplay = document.getElementById('roomCountDisplay');
            roomCountDisplay.textContent = rentalData.length;
            showMessage('Self-Check ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!', false);
        }

    </script>
</body>
</html>

